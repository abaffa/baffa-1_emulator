#include <stdio.h>
#include <conio.h>
#include <stdlib.h>
#include <string.h>
#include <ctype.h>

#include <chrono>
#ifdef __MINGW32__
#include <time.h>
#include <pthread.h> 
#endif

#include "console_local.h"
#include "config.h"
#include "debugmenu_main.h"

#include "sol1_alu_8bit.h"
#include "sol1_cpu.h"
#include "sol1_memory.h"
#include "sol1_rom.h"
#include "sol1_microcode.h"

#include "utils.h"

#include "sol1_register_8bit.h"

#include "ttl74series.h"

#include <math.h>

#define DEBUG_MICROCODE 0
#define DEBUG_UADDRESSER 0
#define DEBUG_UADDER 0
#define DEBUG_UFLAGS 0
#define DEBUG_REGISTERS 0
#define DEBUG_BUSES 0	
#define DEBUG_ALU 0

using namespace std::chrono;

int step = 0;


// FLAG - msw-h - bits
#define MSW_ZF 0x00 // ZeroFlag
#define MSW_CF 0x01 // Carry Flag
#define MSW_SF 0x02 // Overflow Flag
#define MSW_OF 0x03 // Sign Flag
#define MSW_12 0x04
#define MSW_13 0x05
#define MSW_14 0x06
#define MSW_15 0x07

void mswh_flags_desc(struct sol1_cpu* sol1_cpu) {

	SOL1_BYTE b = sol1_register_8bit_value(sol1_cpu->registers.MSWh);
	if (get_byte_bit(b, MSW_ZF) != 0x00)
		printf("zf ");
	if (get_byte_bit(b, MSW_CF) != 0x00)
		printf("cf ");
	if (get_byte_bit(b, MSW_SF) != 0x00)
		printf("sf ");
	if (get_byte_bit(b, MSW_OF) != 0x00)
		printf("of ");
}


// STATUS FLAGS - msw-l bits
SOL1_BYTE msw_dma_ack = 0x00;
SOL1_BYTE msw_interrupt_enable = 0x01;
SOL1_BYTE msw_cpu_mode = 0x02;
SOL1_BYTE msw_paging_en = 0x3;
SOL1_BYTE msw_halt = 0x04;
SOL1_BYTE msw_display_reg_load = 0x05;
//SOL1_BYTE MSW_14 = 0x06; 
SOL1_BYTE msw_dir = 0x07;

void mswl_status_desc(struct sol1_cpu* sol1_cpu) {

	SOL1_BYTE b = sol1_register_8bit_value(sol1_cpu->registers.MSWl);
	if (get_byte_bit(b, msw_dma_ack) != 0x00)
		printf("dma_ack ");
	if (get_byte_bit(b, msw_interrupt_enable) != 0x00)
		printf("interrupt_enable ");
	if (get_byte_bit(b, msw_cpu_mode) != 0x00)
		printf("cpu_mode ");
	if (get_byte_bit(b, msw_paging_en) != 0x00)
		printf("paging_en ");
	if (get_byte_bit(b, msw_halt) != 0x00)
		printf("halt ");
	if (get_byte_bit(b, msw_display_reg_load) != 0x00)
		printf("display_reg_load ");
	if (get_byte_bit(b, msw_dir) != 0x00)
		printf("dir ");
}


struct mccycle {
	SOL1_BYTE next;

	SOL1_BYTE cond_inv;
	SOL1_BYTE cond_flags_src;
	SOL1_BYTE cond_sel;


	SOL1_BYTE ir_wrt;

	SOL1_BYTE shift_src;
	SOL1_BYTE zbus_out_src;






	SOL1_BYTE zf_in_src; // ZeroFlag
	SOL1_BYTE cf_in_src; // Carry Flag
	SOL1_BYTE sf_in_src; // Sign Flag
	SOL1_BYTE of_in_src; // Overflow Flag

	SOL1_BYTE rd;
	SOL1_BYTE wr;


	SOL1_BYTE display_reg_load;
	SOL1_BYTE dl_wrt;
	SOL1_BYTE dh_wrt;
	SOL1_BYTE cl_wrt;
	SOL1_BYTE ch_wrt;
	SOL1_BYTE bl_wrt;
	SOL1_BYTE bh_wrt;
	SOL1_BYTE al_wrt;
	SOL1_BYTE ah_wrt;
	SOL1_BYTE mdr_in_src;
	SOL1_BYTE mdr_out_src;
	SOL1_BYTE mdr_out_en;
	SOL1_BYTE mdrl_wrt;
	SOL1_BYTE mdrh_wrt;
	SOL1_BYTE tdrl_wrt;
	SOL1_BYTE tdrh_wrt;
	SOL1_BYTE dil_wrt;
	SOL1_BYTE dih_wrt;
	SOL1_BYTE sil_wrt;
	SOL1_BYTE sih_wrt;
	SOL1_BYTE marl_wrt;
	SOL1_BYTE marh_wrt;
	SOL1_BYTE bpl_wrt;
	SOL1_BYTE bph_wrt;
	SOL1_BYTE pcl_wrt;
	SOL1_BYTE pch_wrt;
	SOL1_BYTE spl_wrt;
	SOL1_BYTE sph_wrt;



	SOL1_BYTE mar_in_src;


	SOL1_BYTE ptb_wrt;
	SOL1_BYTE pagtbl_ram_we;
	SOL1_BYTE mdr_to_pagtbl_en;
	SOL1_BYTE force_user_ptb;

	SOL1_BYTE gl_wrt;
	SOL1_BYTE gh_wrt;
	SOL1_BYTE imm;


	SOL1_BYTE sspl_wrt = 0x01; ////////?????????????????
	SOL1_BYTE ssph_wrt = 0x01; ////////?????????????????

	SOL1_BYTE page_table_addr_src = 0x0; ////////?????????????????



	//?????????????
	SOL1_BYTE memory_io; // bus_mem_io //?????????????????
	SOL1_BYTE page_present; ////////?????????????????
	SOL1_BYTE page_writable; ////////?????????????????
	//?????????????
	//SOL1_BYTE buffer_rd;
	//SOL1_BYTE buffer_wr;
	//SOL1_BYTE buffer_mem_io;
	//?????????????
	//?????????????



	// STATUS FLAG - msw-l
	//SOL1_BYTE msw_dma_ack; ////////?????????????????
	//SOL1_BYTE msw_interrupt_enable; ////////?????????????????
	//SOL1_BYTE msw_cpu_mode; ////////?????????????????
	//SOL1_BYTE msw_paging_en = 0x0; ////////?????????????????
	//SOL1_BYTE msw_halt; ////////?????????????????
	//SOL1_BYTE msw_display_reg_load; ////////?????????????????
	//SOL1_BYTE MSW_14; ////////?????????????????
	//SOL1_BYTE msw_dir; ////////?????????????????

	SOL1_BYTE status_wrt; //mswl_wrt // status (flags de controle)


	// FLAG - msw-h
	//SOL1_BYTE MSW_ZF = 0x0; // ZeroFlag
	//SOL1_BYTE MSW_CF; // Carry Flag
	//SOL1_BYTE MSW_SF; // Overflow Flag
	//SOL1_BYTE MSW_OF; // Sign Flag
	//SOL1_BYTE MSW_12; ////////?????????????????
	//SOL1_BYTE MSW_13; ////////?????????????????
	//SOL1_BYTE MSW_14; ////////?????????????????
	//SOL1_BYTE MSW_15; ////////?????????????????



	//
	SOL1_BYTE clear_all_ints;
	SOL1_BYTE int_vector; ////////?????????????????
	SOL1_BYTE int_mask; ////////?????????????????
	//SOL1_BYTE int_masks_wrt; ////////?????????????????
	SOL1_BYTE mask_flags_wrt;
	SOL1_BYTE int_status; ////////?????????????????
	SOL1_BYTE int_vector_wrt;
	SOL1_BYTE int_ack;
	SOL1_BYTE int_request; ////////?????????????????
	//


	SOL1_BYTE int_pending; //?? int_request + msw_interrupt_enable
	SOL1_BYTE dma_req; ////////?????????????????
	SOL1_BYTE any_interruption; //?? int_endind "+" dma_req


	SOL1_BYTE wait; ////////?????????????????
	SOL1_BYTE ext_input; ////////?????????????????

	SOL1_BYTE final_condition;


	SOL1_BYTE panel_regsel;
};

struct bus {

	SOL1_BYTE data_bus;

	SOL1_BYTE k_bus; // input pra alu x e y
	SOL1_BYTE w_bus; // input pra alu x e y
	SOL1_BYTE x_bus; //alu entrada
	SOL1_BYTE y_bus; //alu entrada
	SOL1_BYTE z_bus; //alu saida
};


//////////////////////////
//////////////////////////
//////////////////////////
//////////////////////////
//////////////////////////





SOL1_BYTE bus_tristate(sol1_cpu *sol1_cpu) {
	return (get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_dma_ack) |
		get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_halt)) & 0b00000001; //IC151
}


SOL1_BYTE bus_rd(sol1_cpu *sol1_cpu, struct mccycle *mccycle) {

	if (bus_tristate(sol1_cpu) != 0x00)
		return 0x01;

	return (~mccycle->rd) & 0b00000001;
	//return (~(mccycle->rd && bus_tristate(sol1_cpu) == 0x00)) & 0b00000001;
}

SOL1_BYTE bus_wr(sol1_cpu *sol1_cpu, struct mccycle *mccycle) {
	if (bus_tristate(sol1_cpu) != 0x00)
		return 0x01;

	//return (~(mccycle->wr && bus_tristate(sol1_cpu) == 0x00)) & 0b00000001;
	return (~mccycle->wr) & 0b00000001;
}

SOL1_BYTE buffer_rd(sol1_cpu *sol1_cpu, struct mccycle *mccycle) {
	return bus_rd(sol1_cpu, mccycle);
}

SOL1_BYTE buffer_wr(sol1_cpu *sol1_cpu, struct mccycle *mccycle) {
	return bus_wr(sol1_cpu, mccycle);
}



SOL1_BYTE buffer_mem_io(sol1_cpu *sol1_cpu, struct mccycle *mccycle) {
	return mccycle->memory_io;
}



unsigned long read_address_bus(sol1_cpu *sol1_cpu) {
	unsigned long address_bus = 0x00;

	if (bus_tristate(sol1_cpu) == 0x00)
		if (get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_paging_en) == 0x00)
			address_bus = sol1_register_8bit_value(sol1_cpu->memory.MARh) << 8 | sol1_register_8bit_value(sol1_cpu->memory.MARl);

	return address_bus;
}

//////////////////////////
//////////////////////////
//////////////////////////
//////////////////////////
//////////////////////////



SOL1_BYTE refresh_MSWh_ZF(sol1_cpu *sol1_cpu, sol1_alu_8bit *alu, SOL1_BYTE z_bus, SOL1_BYTE zf_in_src) {

	SOL1_BYTE inMSWh_ZF = 0x00;

	switch (zf_in_src & 0b00000011) {
	case 0x00:
		inMSWh_ZF = get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_ZF);
		break;

	case 0x01:
		inMSWh_ZF = get_byte_bit(alu->alu_zf, 0);
		break;
	case 0x02:
		inMSWh_ZF = get_byte_bit(alu->alu_zf & get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_ZF), 0);
		break;

	case 0x03:
		inMSWh_ZF = get_byte_bit(z_bus, 0);
		break;
	}

	return inMSWh_ZF;
}


SOL1_BYTE refresh_MSWh_CF(sol1_cpu *sol1_cpu, sol1_alu_8bit *alu, SOL1_BYTE z_bus, SOL1_BYTE cf_in_src) {

	SOL1_BYTE inMSWh_CF = 0x00;

	switch (cf_in_src & 0b00000111) {
	case 0x00:
		inMSWh_CF = get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_CF);
		break;

	case 0x01:
		inMSWh_CF = get_byte_bit(alu->alu_final_cf, 0);
		break;

	case 0x02:
		inMSWh_CF = get_byte_bit(alu->alu_output, 0);
		break;

	case 0x03:
		inMSWh_CF = get_byte_bit(z_bus, 1);
		break;

	case 0x04:
		inMSWh_CF = get_byte_bit(alu->alu_output, 7);
		break;
	}

	return inMSWh_CF;
}



SOL1_BYTE refresh_MSWh_SF(sol1_cpu *sol1_cpu, sol1_alu_8bit *alu, SOL1_BYTE z_bus, SOL1_BYTE sf_in_src) {

	SOL1_BYTE inMSWh_SF = 0x00;

	switch (sf_in_src & 0b00000011) {
	case 0x00:

		inMSWh_SF = get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_SF);
		break;

	case 0x01:
		inMSWh_SF = get_byte_bit(z_bus, 7);
		break;

	case 0x02:
		inMSWh_SF = 0x00;
		break;

	case 0x03:
		inMSWh_SF = get_byte_bit(z_bus, 2);
		break;
	}

	return inMSWh_SF;
}


SOL1_BYTE refresh_MSWh_OF(sol1_cpu *sol1_cpu, sol1_alu_8bit *alu, SOL1_BYTE z_bus, SOL1_BYTE u_sf, SOL1_BYTE of_in_src) {

	SOL1_BYTE inMSWh_OF = 0x00;

	switch (of_in_src & 0b00000111) {
	case 0x00:
		inMSWh_OF = get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_OF);
		break;

	case 0x01:
		inMSWh_OF = get_byte_bit(alu->alu_of, 0);
		break;

	case 0x02:
		inMSWh_OF = get_byte_bit(z_bus, 7);
		break;

	case 0x03:
		inMSWh_OF = get_byte_bit(z_bus, 3);
		break;

	case 0x04:
		inMSWh_OF = get_byte_bit(u_sf, 0) != get_byte_bit(z_bus, 7);
		break;
	}

	return inMSWh_OF;
}



SOL1_BYTE ALU_EXEC(sol1_alu_8bit *alu, SOL1_BYTE x_bus, SOL1_BYTE y_bus,
	SOL1_BYTE alu_op,
	SOL1_BYTE alu_mode,
	SOL1_BYTE alu_cf_in_src,
	SOL1_BYTE alu_cf_in_inv,
	SOL1_BYTE alu_cf_out_inv,
	SOL1_BYTE u_cf, SOL1_BYTE msw_cf, SOL1_BYTE shift_src, SOL1_BYTE zbus_out_src) {


	alu->alu_op = alu_op;
	alu->alu_mode = alu_mode;
	alu->alu_cf_in_src = alu_cf_in_src;
	alu->alu_cf_in_inv = alu_cf_in_inv;
	alu->alu_cf_out_inv = alu_cf_out_inv;


	SOL1_BYTE z_bus = 0;

	SOL1_BYTE alu_cin = 0x00;
	if ((alu_cf_in_src & 0b00000011) == 0x01)
		alu_cin = msw_cf;

	else if ((alu_cf_in_src & 0b00000011) == 0x02)
		alu_cin = u_cf;

	alu_cin = (alu_cin ^ alu_cf_in_inv) & 0b00000001;
	sol1_alu_8bit_op(alu, x_bus, y_bus, alu_cin & 0b00000001, alu_op, alu_mode);

	alu->alu_cf = alu->COUT;
	alu->alu_final_cf = (alu->alu_cf ^ (alu_cf_out_inv)) & 0b00000001;


	/////////////////////////////////////////////////////////////////
	// test OF (OVERFLOW)
	///SOL1_BYTE inIC86_1A = IC_74LS86(get_byte_bit(z_bus, 7), get_byte_bit(x_bus, 7));

	//SOL1_BYTE inIC02_0A = IC_74LS02(get_byte_bit(alu_op, 2), get_byte_bit(alu_op, 1));
	//SOL1_BYTE inIC10_0A = IC_74LS10(get_byte_bit(alu_op, 0), get_byte_bit(alu_op, 3), inIC02_0A); //alu_op == add

	//SOL1_BYTE inIC86_1B = IC_74LS86(get_byte_bit(x_bus, 7), get_byte_bit(y_bus, 7)); //ALU_OP == SUB
	//SOL1_BYTE inIC86_1C = IC_74LS86(inIC10_0A, inIC86_1B);

	//SOL1_BYTE inIC10_0B = IC_74LS10(inIC86_1A, 0x01, IC_74LS04(inIC86_1C));

	//alu->alu_of = IC_74LS04(inIC10_0B);

	SOL1_BYTE zNEQx = (get_byte_bit(z_bus, 7) != get_byte_bit(x_bus, 7));
	SOL1_BYTE xNEQy = (get_byte_bit(x_bus, 7) != get_byte_bit(y_bus, 7));

	alu->alu_of = zNEQx && ((alu_op != 0b1001) == xNEQy);
	//
	/////////////////////////////////////////////////////////////////
	// SHIFT
	SOL1_BYTE inIC16 = 0x00;

	if (shift_src == 0x01)
		inIC16 = 0x00;

	else if (shift_src == 0x01)
		inIC16 = u_cf;

	else if (shift_src == 0x02)
		inIC16 = msw_cf;

	else if (shift_src == 0x03)
		inIC16 = get_byte_bit(alu->alu_output, 0);

	else if (shift_src == 0x04)
		inIC16 = get_byte_bit(alu->alu_output, 7);

	else if (shift_src == 0x05 ||
		shift_src == 0x06 ||
		shift_src == 0x07)
		inIC16 = 0x01;


	if ((zbus_out_src & 0b00000011) == 0x00)
		z_bus = alu->alu_output;

	else if ((zbus_out_src & 0b00000011) == 0x01)
		z_bus = (alu->alu_output >> 1) | (inIC16 << 7);

	else if ((zbus_out_src & 0b00000011) == 0x02)
		z_bus = (alu->alu_output << 1) | inIC16;

	else if ((zbus_out_src & 0b00000011) == 0x03)
		z_bus = get_byte_bit(alu->alu_output, 7) != 0x00 ? 0b11111111 : 0b00000000;

	/*
	SHL: MSB goes into CF.LSB replaced by 0
	SLA : same as SHL
	ROL : LSB becomes MSB.
	RLC : MSB goes into CF.LSB becomes CF

	SHR : LSB goes into CF.MSB replaced by 0
	SRA : LSB goes into CF.MSB is whatever the previous one was
	ROR : MSB becomes LSB
	RRC : MSB becomes CF.LSB goes into CF*/
	/////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////
	//
	alu->alu_zf = (z_bus == 0x00);

	if (DEBUG_ALU) {
		printf("***** ALU\n");
		sol1_alu_display_registers(alu);
		printf("******************************************************************************\n");
	}

	return z_bus;
}



SOL1_DWORD UADDRESSER(
	struct sol1_cpu *sol1_cpu,
	struct sol1_microcode *sol1_microcode,
	struct mccycle *mccycle) {


	////////////////////////////////////////////////////////////////////////////

	SOL1_BYTE inIC15A = get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_ZF) | ((sol1_microcode->u_zf & 0b00000001) << 1) | (get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_CF) << 2) | ((sol1_microcode->u_cf & 0b00000001) << 3);
	SOL1_BYTE inIC15B = get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_SF) | ((sol1_microcode->u_sf & 0b00000001) << 1) | (get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_OF) << 2) | ((sol1_microcode->u_of & 0b00000001) << 3);

	SOL1_BYTE inIC15 = IC_74LS257(inIC15A, inIC15B, mccycle->cond_flags_src);

	SOL1_BYTE inIC59B = IC_74LS86(get_byte_bit(inIC15, 2), get_byte_bit(inIC15, 3));
	SOL1_BYTE inIC153B = IC_74LS32(inIC15 & 0b00000001, inIC59B & 0b00000001);
	SOL1_BYTE inIC167B = IC_74LS32(inIC15 & 0b00000001, get_byte_bit(inIC15, 1));

	SOL1_BYTE inIC61D = (inIC15 & 0b00001111) | ((inIC59B & 0b00000001) << 4) | ((inIC153B & 0b00000001) << 5) | ((inIC167B & 0b00000001) << 6) | ((mccycle->dma_req & 0b00000001) << 7);
	SOL1_BYTE inIC61 = IC_74LS151(inIC61D, mccycle->cond_sel & 0b00000111, 0x00);

	SOL1_BYTE inIC12D = get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_cpu_mode) | ((mccycle->wait & 0b00000001) << 1) | ((mccycle->int_pending & 0b00000001) << 2) | ((mccycle->ext_input & 0b00000001) << 3) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_dir) << 4) | (get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_display_reg_load) << 5);
	SOL1_BYTE inIC12 = IC_74LS151(inIC61D, mccycle->cond_sel & 0b00000111, 0x00);

	SOL1_BYTE inIC341 = IC_74LS253(inIC61 & 0b00000001, inIC12 & 0b00000001, get_byte_bit(mccycle->cond_sel, 3), 0x00);
	SOL1_BYTE inIC175B = IC_74LS86(mccycle->cond_inv & 0b00000001, inIC341 & 0b00000001);


	mccycle->final_condition = inIC175B & 0b00000001;
	//if type = branch, and condition = false, then next = +1

	/*
	typ = next!
	em 2 campos chamados next_0 e next_1.
		Paulo enviou 7 de maio às 02:37
		next = 00 : proximo ciclo definido pelo valor OFFSET
		next = 01 : usado para branches
		next = 10 : proximo ciclo eh instruction fetch
		next = 11 : proximo ciclo definido por IR
		*/
		//Typ1 Typ0		Desc
		//0    0		offset
		//0    1		branch
		//1    0		pre-fetch
		//1    1		post_fetch

	SOL1_BYTE typ_0 = (mccycle->next & 0b00000001);
	SOL1_BYTE typ_1 = (mccycle->next & 0b00000010) >> 1;

	SOL1_BYTE mux_A = IC_74LS08( //IC45A
		typ_1,
		IC_74LS32(typ_0,	//IC94B
			IC_74LS08(                //IC119A
				IC_74LS04(typ_0),     //IC43D 
				mccycle->any_interruption
			)
		)
	);

	SOL1_BYTE mux_B = IC_74LS08( //IC45A
		typ_1,
		IC_74LS04(typ_0)     //IC43D 
	);

	SOL1_BYTE mux = (mux_B << 1) | mux_A;


	//MICROCODE 0 TO 63
	//IS RESERVED FOR CPU STARTUP.
	//U_FETCH AT 0x10
	//U_TRAP AT 0x20
	SOL1_DWORD u_fetch = 0x10;
	SOL1_DWORD u_trap = 0x20;

	/*

	/////////////////////////////////////////////
	SOL1_BYTE in01_A = (mc->u_adder & SOL1_BITMASK_0) |
		((u_fetch & SOL1_BITMASK_0) << 2) |
		((u_trap & SOL1_BITMASK_0) << 3);

	SOL1_BYTE in01_B = get_word_bit(mc->u_adder, 1) |
		(get_word_bit(u_fetch, 1) << 2) |
		(get_word_bit(u_trap, 1) << 3);

	SOL1_BYTE res01 = IC_74LS153( //IC34
		in01_A,
		in01_B,
		mux,
		0x00);


	SOL1_BYTE in02_A = get_word_bit(mc->u_adder, 2) |
		(get_word_bit(u_fetch, 2) << 2) |
		(get_word_bit(u_trap, 2) << 3);

	SOL1_BYTE in02_B = get_word_bit(mc->u_adder, 3) |
		(get_word_bit(u_fetch, 3) << 2) |
		(get_word_bit(u_trap, 3) << 3);

	SOL1_BYTE res02 = IC_74LS153( //IC35
		in02_A,
		in02_B,
		mux,
		0x00);


	SOL1_BYTE in03_A = get_word_bit(mc->u_adder, 4) |
		(get_word_bit(u_fetch, 4) << 2) |
		(get_word_bit(u_trap, 4) << 3);

	SOL1_BYTE in03_B = get_word_bit(mc->u_adder, 5) |
		(get_word_bit(u_fetch, 5) << 2) |
		(get_word_bit(u_trap, 5) << 3);

	SOL1_BYTE res03 = IC_74LS153( //IC36
		in03_A,
		in03_B,
		mux,
		0x00);


	SOL1_BYTE in04_A = get_word_bit(mc->u_adder, 6) |
		((ir & SOL1_BITMASK_0) << 1) |
		(get_word_bit(u_fetch, 6) << 2) |
		(get_word_bit(u_trap, 6) << 3);

	SOL1_BYTE in04_B = get_word_bit(mc->u_adder, 7) |
		(get_word_bit(ir, 1) << 1) |
		(get_word_bit(u_fetch, 7) << 2) |
		(get_word_bit(u_trap, 7) << 3);

	SOL1_BYTE res04 = IC_74LS153(//IC37
		in04_A,
		in04_B,
		mux,
		0x00);


	SOL1_BYTE in05_A = get_word_bit(mc->u_adder, 8) |
		(get_word_bit(ir, 2) << 1) |
		(get_word_bit(u_fetch, 8) << 2) |
		(get_word_bit(u_trap, 8) << 3);

	SOL1_BYTE in05_B = get_word_bit(mc->u_adder, 9) |
		(get_word_bit(ir, 3) << 1) |
		(get_word_bit(u_fetch, 9) << 2) |
		(get_word_bit(u_trap, 9) << 3);

	SOL1_BYTE res05 = IC_74LS153(//IC38
		in05_A,
		in05_B,
		mux,
		0x00);


	SOL1_BYTE in06_A = get_word_bit(mc->u_adder, 10) |
		(get_word_bit(ir, 4) << 1) |
		(get_word_bit(u_fetch, 10) << 2) |
		(get_word_bit(u_trap, 10) << 3);

	SOL1_BYTE in06_B = get_word_bit(mc->u_adder, 11) |
		(get_word_bit(ir, 5) << 1) |
		(get_word_bit(u_fetch, 11) << 2) |
		(get_word_bit(u_trap, 11) << 3);

	SOL1_BYTE res06 = IC_74LS153(//IC40
		in06_A,
		in06_B,
		mux,
		0x00);


	SOL1_BYTE in07_A = get_word_bit(mc->u_adder, 12) |
		(get_word_bit(ir, 6) << 1) |
		(get_word_bit(u_fetch, 12) << 2) |
		(get_word_bit(u_trap, 12) << 3);

	SOL1_BYTE in07_B = get_word_bit(mc->u_adder, 13) |
		(get_word_bit(ir, 7) << 1) |
		(get_word_bit(u_fetch, 13) << 2) |
		(get_word_bit(u_trap, 13) << 3);

	SOL1_BYTE res07 = IC_74LS153(//IC73
		in07_A,
		in07_B,
		mux,
		0x00);

	SOL1_DWORD u_address_mux_l =
		res01 |
		(res02 << (1 * 2)) |
		(res03 << (2 * 2)) |
		(res04 << (3 * 2));

	SOL1_DWORD u_address_mux_h =
		res05 |
		(res06 << (1 * 2)) |
		(res07 << (2 * 2));
	*/
	SOL1_DWORD u_address_mux_l = 0x00;
	SOL1_DWORD u_address_mux_h = 0x00;

	if (mux == 0x00) {
		u_address_mux_l = sol1_microcode->u_adder & 0b00000011111111;
		u_address_mux_h = (sol1_microcode->u_adder & 0b11111100000000) >> 8;
	}
	else if (mux == 0x01) {
		u_address_mux_l = (sol1_register_8bit_value(sol1_microcode->IR) & 0b00000011) << 6;
		u_address_mux_h = (sol1_register_8bit_value(sol1_microcode->IR) & 0b11111100) >> 2;
	}
	else if (mux == 0x02) {
		u_address_mux_l = u_fetch & 0b00000011111111;
		u_address_mux_h = (u_fetch & 0b11111100000000) >> 8;
	}
	else if (mux == 0x03) {
		u_address_mux_l = u_trap & 0b00000011111111;
		u_address_mux_h = (u_trap & 0b11111100000000) >> 8;
	}

	SOL1_BYTE u_address_l = IC_74LS273(sol1_microcode->U_ADDRESSl, u_address_mux_l, 0x1, 0x1); //~clk, ~rst
	SOL1_BYTE u_address_h = IC_74LS273(sol1_microcode->U_ADDRESSh, u_address_mux_h, 0x1, 0x1); //~clk, ~rst

	sol1_microcode->old_u_ad_bus = sol1_microcode->u_ad_bus;
	sol1_microcode->u_ad_bus = (((SOL1_DWORD)u_address_h) << 8) | u_address_l;



	if (DEBUG_UADDRESSER) {
		printf("***** U_ADDRESSER\n");
		printf("* Next(typ): "); print_nibble_bin(mccycle->next);
		printf(" | Any Interruption: "); print_nibble_bin(mccycle->any_interruption);
		printf(" | Mux_B: "); print_nibble_bin(mux_B);
		printf(" | Mux_A: "); print_nibble_bin(mux_A);
		printf("\n");

		/*
		printf("* "); print_byte_bin(in01_A); printf(" | ");  print_byte_bin(in01_B); printf(" | ");  print_byte_bin(res01); printf("\n");
		printf("* "); print_byte_bin(in02_A); printf(" | ");  print_byte_bin(in02_B); printf(" | ");  print_byte_bin(res02); printf("\n");
		printf("* "); print_byte_bin(in03_A); printf(" | ");  print_byte_bin(in03_B); printf(" | ");  print_byte_bin(res03); printf("\n");
		printf("* "); print_byte_bin(in04_A); printf(" | ");  print_byte_bin(in04_B); printf(" | ");  print_byte_bin(res04); printf("\n");
		printf("* "); print_byte_bin(in05_A); printf(" | ");  print_byte_bin(in05_B); printf(" | ");  print_byte_bin(res05); printf("\n");
		printf("* "); print_byte_bin(in06_A); printf(" | ");  print_byte_bin(in06_B); printf(" | ");  print_byte_bin(res06); printf("\n");
		printf("* "); print_byte_bin(in07_A); printf(" | ");  print_byte_bin(in07_B); printf(" | ");  print_byte_bin(res07); printf("\n");
		*/
		printf("* U_ADDRESS=%04x", sol1_registers_value(sol1_microcode->U_ADDRESSl, sol1_microcode->U_ADDRESSh));
		printf(" | ");
		printf("U_AD=%04x", sol1_microcode->u_ad_bus);
		printf(" | ");
		printf("Mux: "); print_nibble_bin(mux);
		printf("\n");

		printf("******************************************************************************\n");
	}

	return sol1_microcode->u_ad_bus;
}










SOL1_BYTE refresh_k_bus(SOL1_BYTE alu_b_src, sol1_cpu *sol1_cpu) {

	/*
	SOL1_BYTE inK0 = IC_74LS153( //IC92
		(sol1_register_8bit_value(sol1_cpu->memory.MDRl) & SOL1_BITMASK_0) |
		((sol1_register_8bit_value(sol1_cpu->memory.MDRh) & SOL1_BITMASK_0) << 1) |
		((sol1_register_8bit_value(sol1_cpu->registers.TDRl) & SOL1_BITMASK_0) << 2) |
		((sol1_register_8bit_value(sol1_cpu->registers.TDRh) & SOL1_BITMASK_0) << 3),

		get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRl), 1) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRh), 1) << 1) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRl), 1) << 2) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRh), 1) << 3),
		alu_b_src,
		0x00);

	SOL1_BYTE inK1 = IC_74LS153( //I103
		get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRl), 2) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRh), 2) << 1) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRl), 2) << 2) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRh), 2) << 3),

		get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRl), 3) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRh), 3) << 1) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRl), 3) << 2) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRh), 3) << 3),
		alu_b_src,
		0x00);

	SOL1_BYTE inK2 = IC_74LS153( //I116
		get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRl), 4) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRh), 4) << 1) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRl), 4) << 2) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRh), 4) << 3),

		get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRl), 5) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRh), 5) << 1) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRl), 5) << 2) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRh), 5) << 3),
		alu_b_src,
		0x00);

	SOL1_BYTE inK3 = IC_74LS153( //I116
		get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRl), 6) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRh), 6) << 1) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRl), 6) << 2) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRh), 6) << 3),

		get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRl), 7) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRh), 7) << 1) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRl), 7) << 2) |
		(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRh), 7) << 3),
		alu_b_src,
		0x00);

	SOL1_BYTE k_bus = (inK0 & 0b00000011) | ((inK1 & 0b00000011) << 2) | ((inK2 & 0b00000011) << 4) | ((inK3 & 0b00000011) << 6);
	return k_bus;

	*/

	SOL1_BYTE k_bus = 0x00;
	switch (alu_b_src & 0b00000011) {
	case 0x00: k_bus = sol1_register_8bit_value(sol1_cpu->memory.MDRl); break;
	case 0x01: k_bus = sol1_register_8bit_value(sol1_cpu->memory.MDRh); break;
	case 0x02: k_bus = sol1_register_8bit_value(sol1_cpu->registers.TDRl); break;
	case 0x03: k_bus = sol1_register_8bit_value(sol1_cpu->registers.TDRh); break;
	}

	return k_bus;
}

SOL1_BYTE refresh_w_bus(
	SOL1_BYTE panel_regsel,
	SOL1_BYTE alu_a_src,
	SOL1_BYTE display_reg_load,
	SOL1_BYTE int_vector,
	SOL1_BYTE int_masks,
	SOL1_BYTE int_status,
	sol1_cpu *sol1_cpu) {



	/*
SOL1_BYTE inDisplayOEAB = IC_74LS27(bus_tristate(sol1_cpu), 0x00, display_reg_load) & 0b00000001;

SOL1_BYTE inDisplay01_A = panel_regsel & 0b00001111;
SOL1_BYTE inDisplay01_B = alu_a_src & 0b00001111;
SOL1_BYTE inDisplay01_res = IC_74LS257(inDisplay01_A, inDisplay01_B, inDisplayOEAB); //IC125

SOL1_BYTE inDisplay02_A = (panel_regsel >> 4) & 0b00000001;
SOL1_BYTE inDisplay02_B = (alu_a_src >> 4) & 0b00000001;
SOL1_BYTE inDisplay02_res = IC_74LS257(inDisplay02_A, inDisplay02_B, inDisplayOEAB); //IC118

SOL1_BYTE inABC = inDisplay01_res & 0b00000111;
SOL1_BYTE inAB = get_byte_bit(inDisplay01_res, 3) | ((inDisplay02_res & 0b00000001) << 1);

SOL1_BYTE in00 = IC_74LS151( //IC3
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Al), 0) |
	((sol1_register_8bit_value(sol1_cpu->registers.Ah), 0) << 1) |
	((sol1_register_8bit_value(sol1_cpu->registers.Bl), 0) << 2) |
	((sol1_register_8bit_value(sol1_cpu->registers.Bh), 0) << 3) |
	((sol1_register_8bit_value(sol1_cpu->registers.Cl), 0) << 4) |
	((sol1_register_8bit_value(sol1_cpu->registers.Ch), 0) << 5) |
	((sol1_register_8bit_value(sol1_cpu->registers.Dl), 0) << 6) |
	((sol1_register_8bit_value(sol1_cpu->registers.Dh), 0) << 7),
	inABC, 0x00);

SOL1_BYTE in01 = IC_74LS151( //IC2
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SPl), 0) |
	((sol1_register_8bit_value(sol1_cpu->registers.SPh), 0) << 1) |
	((sol1_register_8bit_value(sol1_cpu->registers.BPl), 0) << 2) |
	((sol1_register_8bit_value(sol1_cpu->registers.BPh), 0) << 3) |
	((sol1_register_8bit_value(sol1_cpu->registers.SIl), 0) << 4) |
	((sol1_register_8bit_value(sol1_cpu->registers.SIh), 0) << 5) |
	((sol1_register_8bit_value(sol1_cpu->registers.DIl), 0) << 6) |
	((sol1_register_8bit_value(sol1_cpu->registers.DIh), 0) << 7),
	inABC, 0x00);

SOL1_BYTE in02 = IC_74LS151( //IC9
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.PCl), 0) |
	((sol1_register_8bit_value(sol1_cpu->registers.PCh), 0) << 1) |
	((sol1_register_8bit_value(sol1_cpu->memory.MARl), 0) << 2) |
	((sol1_register_8bit_value(sol1_cpu->memory.MARh), 0) << 3) |
	((sol1_register_8bit_value(sol1_cpu->memory.MDRl), 0) << 4) |
	((sol1_register_8bit_value(sol1_cpu->memory.MDRh), 0) << 5) |
	((sol1_register_8bit_value(sol1_cpu->registers.TDRl), 0) << 6) |
	((sol1_register_8bit_value(sol1_cpu->registers.TDRh), 0) << 7),
	inABC, 0x00);

SOL1_BYTE in03 = IC_74LS151( //IC42
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SSPl), 0) |
	((sol1_register_8bit_value(sol1_cpu->registers.SSPh), 0) << 1) |
	((int_vector, 0) << 2) |
	((int_mask, 0) << 3) |
	((int_status, 0) << 4),
	inABC, 0x00);

//

SOL1_BYTE in10 = IC_74LS151( //IC6
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Al), 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Ah), 1) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Bl), 1) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Bh), 1) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Cl), 1) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Ch), 1) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Dl), 1) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Dh), 1) << 7),
	inABC, 0x00);

SOL1_BYTE in11 = IC_74LS151( //IC20
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SPl), 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SPh), 1) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.BPl), 1) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.BPh), 1) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SIl), 1) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SIh), 1) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.DIl), 1) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.DIh), 1) << 7),
	inABC, 0x00);

SOL1_BYTE in12 = IC_74LS151( //IC5
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.PCl), 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.PCh), 1) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MARl), 1) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MARh), 1) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRl), 1) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRh), 1) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRl), 1) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRh), 1) << 7),
	inABC, 0x00);

SOL1_BYTE in13 = IC_74LS151( //IC80
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SSPl), 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SSPh), 1) << 1) |
	(get_byte_bit(int_vector, 1) << 2) |
	(get_byte_bit(int_mask, 1) << 3) |
	(get_byte_bit(int_status, 1) << 4),
	inABC, 0x00);

SOL1_BYTE in0 = IC_74LS153(
	get_byte_bit(in00, 0) |
	(get_byte_bit(in01, 0) << 1) |
	(get_byte_bit(in02, 0) << 2) |
	(get_byte_bit(in03, 0) << 3),
	get_byte_bit(in10, 0) |
	(get_byte_bit(in11, 0) << 1) |
	(get_byte_bit(in12, 0) << 2) |
	(get_byte_bit(in13, 0) << 3),
	inAB, 0x00);
///
SOL1_BYTE in20 = IC_74LS151( //IC41
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Al), 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Ah), 2) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Bl), 2) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Bh), 2) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Cl), 2) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Ch), 2) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Dl), 2) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Dh), 2) << 7),
	inABC, 0x00);

SOL1_BYTE in21 = IC_74LS151( //IC44
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SPl), 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SPh), 2) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.BPl), 2) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.BPh), 2) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SIl), 2) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SIh), 2) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.DIl), 2) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.DIh), 2) << 7),
	inABC, 0x00);

SOL1_BYTE in22 = IC_74LS151( //IC30
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.PCl), 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.PCh), 2) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MARl), 2) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MARh), 2) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRl), 2) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRh), 2) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRl), 2) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRh), 2) << 7),
	inABC, 0x00);

SOL1_BYTE in23 = IC_74LS151( //IC130
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SSPl), 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SSPh), 2) << 2) |
	(get_byte_bit(int_vector, 2) << 2) |
	(get_byte_bit(int_mask, 2) << 3) |
	(get_byte_bit(int_status, 2) << 4),
	inABC, 0x00);

//

SOL1_BYTE in30 = IC_74LS151( //IC56
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Al), 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Ah), 3) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Bl), 3) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Bh), 3) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Cl), 3) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Ch), 3) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Dl), 3) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Dh), 3) << 7),
	inABC, 0x00);

SOL1_BYTE in31 = IC_74LS151( //IC62
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SPl), 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SPh), 3) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.BPl), 3) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.BPh), 3) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SIl), 3) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SIh), 3) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.DIl), 3) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.DIh), 3) << 7),
	inABC, 0x00);

SOL1_BYTE in32 = IC_74LS151( //IC53
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.PCl), 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.PCh), 3) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MARl), 3) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MARh), 3) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRl), 3) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRh), 3) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRl), 3) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRh), 3) << 7),
	inABC, 0x00);

SOL1_BYTE in33 = IC_74LS151( //IC133
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SSPl), 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SSPh), 3) << 1) |
	(get_byte_bit(int_vector, 3) << 2) |
	(get_byte_bit(int_mask, 3) << 3) |
	(get_byte_bit(int_status, 3) << 4),
	inABC, 0x00);

SOL1_BYTE in1 = IC_74LS153(
	get_byte_bit(in20, 0) |
	(get_byte_bit(in21, 0) << 1) |
	(get_byte_bit(in22, 0) << 2) |
	(get_byte_bit(in23, 0) << 3),
	get_byte_bit(in30, 0) |
	(get_byte_bit(in31, 0) << 1) |
	(get_byte_bit(in32, 0) << 2) |
	(get_byte_bit(in33, 0) << 3),
	inAB, 0x00);
///

SOL1_BYTE in40 = IC_74LS151( //IC68
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Al), 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Ah), 4) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Bl), 4) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Bh), 4) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Cl), 4) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Ch), 4) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Dl), 4) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Dh), 4) << 7),
	inABC, 0x00);

SOL1_BYTE in41 = IC_74LS151( //IC69
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SPl), 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SPh), 4) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.BPl), 4) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.BPh), 4) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SIl), 4) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SIh), 4) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.DIl), 4) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.DIh), 4) << 7),
	inABC, 0x00);

SOL1_BYTE in42 = IC_74LS151( //IC67
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.PCl), 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.PCh), 4) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MARl), 4) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MARh), 4) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRl), 4) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRh), 4) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRl), 4) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRh), 4) << 7),
	inABC, 0x00);

SOL1_BYTE in43 = IC_74LS151( //IC141
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SSPl), 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SSPh), 4) << 2) |
	(get_byte_bit(int_vector, 4) << 2) |
	(get_byte_bit(int_mask, 4) << 3) |
	(get_byte_bit(int_status, 4) << 4),
	inABC, 0x00);

//

SOL1_BYTE in50 = IC_74LS151( //IC81
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Al), 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Ah), 5) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Bl), 5) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Bh), 5) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Cl), 5) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Ch), 5) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Dl), 5) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Dh), 5) << 7),
	inABC, 0x00);

SOL1_BYTE in51 = IC_74LS151( //IC82
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SPl), 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SPh), 5) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.BPl), 5) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.BPh), 5) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SIl), 5) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SIh), 5) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.DIl), 5) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.DIh), 5) << 7),
	inABC, 0x00);

SOL1_BYTE in52 = IC_74LS151( //IC71
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.PCl), 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.PCh), 5) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MARl), 5) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MARh), 5) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRl), 5) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRh), 5) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRl), 5) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRh), 5) << 7),
	inABC, 0x00);

SOL1_BYTE in53 = IC_74LS151( //IC144
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SSPl), 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SSPh), 5) << 1) |
	(get_byte_bit(int_vector, 5) << 2) |
	(get_byte_bit(int_mask, 5) << 3) |
	(get_byte_bit(int_status, 5) << 4),
	inABC, 0x00);

SOL1_BYTE in2 = IC_74LS153(
	get_byte_bit(in40, 0) |
	(get_byte_bit(in41, 0) << 1) |
	(get_byte_bit(in42, 0) << 2) |
	(get_byte_bit(in43, 0) << 3),
	get_byte_bit(in50, 0) |
	(get_byte_bit(in51, 0) << 1) |
	(get_byte_bit(in52, 0) << 2) |
	(get_byte_bit(in53, 0) << 3),
	inAB, 0x00);
///

SOL1_BYTE in60 = IC_74LS151( //IC85
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Al), 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Ah), 6) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Bl), 6) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Bh), 6) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Cl), 6) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Ch), 6) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Dl), 6) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Dh), 6) << 7),
	inABC, 0x00);

SOL1_BYTE in61 = IC_74LS151( //IC86
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SPl), 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SPh), 6) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.BPl), 6) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.BPh), 6) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SIl), 6) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SIh), 6) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.DIl), 6) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.DIh), 6) << 7),
	inABC, 0x00);

SOL1_BYTE in62 = IC_74LS151( //IC84
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.PCl), 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.PCh), 6) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MARl), 6) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MARh), 6) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRl), 6) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRh), 6) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRl), 6) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRh), 6) << 7),
	inABC, 0x00);

SOL1_BYTE in63 = IC_74LS151( //IC152
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SSPl), 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SSPh), 6) << 2) |
	(get_byte_bit(int_vector, 4) << 2) |
	(get_byte_bit(int_mask, 4) << 3) |
	(get_byte_bit(int_status, 4) << 4),
	inABC, 0x00);

//

SOL1_BYTE in70 = IC_74LS151( //IC88
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Al), 7) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Ah), 7) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Bl), 7) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Bh), 7) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Cl), 7) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Ch), 7) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Dl), 7) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.Dh), 7) << 7),
	inABC, 0x00);

SOL1_BYTE in71 = IC_74LS151( //IC89
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SPl), 7) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SPh), 7) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.BPl), 7) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.BPh), 7) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SIl), 7) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SIh), 7) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.DIl), 7) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.DIh), 7) << 7),
	inABC, 0x00);

SOL1_BYTE in72 = IC_74LS151( //IC86
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.PCl), 7) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.PCh), 7) << 1) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MARl), 7) << 2) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MARh), 7) << 3) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRl), 7) << 4) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->memory.MDRh), 7) << 5) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRl), 7) << 6) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.TDRh), 7) << 7),
	inABC, 0x00);

SOL1_BYTE in73 = IC_74LS151( //IC160
	get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SSPl), 7) |
	(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.SSPh), 7) << 1) |
	(get_byte_bit(int_vector, 7) << 2) |
	(get_byte_bit(int_mask, 7) << 3) |
	(get_byte_bit(int_status, 7) << 4),
	inABC, 0x00);

SOL1_BYTE in3 = IC_74LS153(
	get_byte_bit(in60, 0) |
	(get_byte_bit(in61, 0) << 1) |
	(get_byte_bit(in62, 0) << 2) |
	(get_byte_bit(in63, 0) << 3),
	get_byte_bit(in70, 0) |
	(get_byte_bit(in71, 0) << 1) |
	(get_byte_bit(in72, 0) << 2) |
	(get_byte_bit(in73, 0) << 3),
	inAB, 0x00);
///

SOL1_BYTE w_bus =
	(in0 & 0b00000011) |
	((in1 & 0b00000011) << 2) |
	((in2 & 0b00000011) << 4) |
	((in3 & 0b00000011) << 6);
	*/


	SOL1_BYTE w_bus = 0x00;

	SOL1_BYTE inABC = 0x00;
	SOL1_BYTE inAB = 0x00;

	if (bus_tristate(sol1_cpu) == 0x00 & display_reg_load == 0x00) {
		inABC = alu_a_src & 0b00000111;
		inAB = get_byte_bit(alu_a_src, 3) | set_byte_bit(get_byte_bit(alu_a_src, 4), 1);
	}
	else {
		inABC = panel_regsel & 0b00000111;
		inAB = get_byte_bit(panel_regsel, 3) | set_byte_bit(get_byte_bit(panel_regsel, 4), 1);
	}


	if (inAB == 0x00) {
		switch (inABC) {
		case 0x00:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.Al);
			break;
		case 0x01:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.Ah);
			break;
		case 0x02:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.Bl);
			break;
		case 0x03:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.Bh);
			break;
		case 0x04:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.Cl);
			break;
		case 0x05:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.Ch);
			break;
		case 0x06:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.Dl);
			break;
		case 0x07:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.Dh);
			break;
		}

	}
	else if (inAB == 0x01) {
		switch (inABC) {
		case 0x00:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.SPl);
			break;
		case 0x01:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.SPh);
			break;
		case 0x02:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.BPl);
			break;
		case 0x03:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.BPh);
			break;
		case 0x04:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.SIl);
			break;
		case 0x05:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.SIh);
			break;
		case 0x06:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.DIl);
			break;
		case 0x07:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.DIh);
			break;
		}
	}
	else if (inAB == 0x02) {
		switch (inABC) {
		case 0x00:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.PCl);
			break;
		case 0x01:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.PCh);
			break;
		case 0x02:
			w_bus = sol1_register_8bit_value(sol1_cpu->memory.MARl);
			break;
		case 0x03:
			w_bus = sol1_register_8bit_value(sol1_cpu->memory.MARh);
			break;
		case 0x04:
			w_bus = sol1_register_8bit_value(sol1_cpu->memory.MDRl);
			break;
		case 0x05:
			w_bus = sol1_register_8bit_value(sol1_cpu->memory.MDRh);
			break;
		case 0x06:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.TDRl);
			break;
		case 0x07:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.TDRh);
			break;
		}
	}
	else if (inAB == 0x03) {
		switch (inABC) {
		case 0x00:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.SSPl);
			break;
		case 0x01:
			w_bus = sol1_register_8bit_value(sol1_cpu->registers.SSPh);
			break;
		case 0x02:
			w_bus = int_vector;
			break;
		case 0x03:
			w_bus = int_masks;
			break;
		case 0x04:
			w_bus = int_status;
			break;
		}
	}
	return w_bus;
}


void mc_seq_update(sol1_cpu *sol1_cpu,
	sol1_alu_8bit *alu,
	sol1_microcode *sol1_microcode,
	struct mccycle *mccycle) {

	const char* SOL1_ROM_CONTROL_LIST[] = {
"next_0", "next_1", "offset_0", "offset_1", "offset_2", "offset_3", "offset_4", "offset_5", "offset_6", "cond_inv", "cond_flags_src", "cond_sel_0",
"cond_sel_1", "cond_sel_2", "cond_sel_3", "ESCAPE", "uzf_in_src_0", "uzf_in_src_1", "ucf_in_src_0", "ucf_in_src_1", "usf_in_src", "uof_in_src", "IR_wrt", "status_wrt",
"shift_src_0", "shift_src_1", "shift_src_2", "zbus_out_src_0", "zbus_out_src_1", "alu_a_src_0", "alu_a_src_1", "alu_a_src_2", "alu_a_src_3", "alu_a_src_4", "alu_a_src_5",
"alu_op_0", "alu_op_1", "alu_op_2", "alu_op_3", "alu_mode", "alu_cf_in_src_0", "alu_cf_in_src_1", "alu_cf_in_inv", "zf_in_src_0", "zf_in_src_1", "alu_cf_out_inv",
"cf_in_src_0", "cf_in_src_1", "cf_in_src_2", "sf_in_src_0", "sf_in_src_1", "of_in_src_0", "of_in_src_1", "of_in_src_2", "rd", "wr", "alu_b_src_0", "alu_b_src_1",
"alu_b_src_2", "display_reg_load", "dl_wrt", "dh_wrt", "cl_wrt", "ch_wrt", "bl_wrt", "bh_wrt", "al_wrt", "ah_wrt", "mdr_in_src", "mdr_out_src", "mdr_out_en",
"mdrl_wrt", "mdrh_wrt", "tdrl_wrt", "tdrh_wrt", "dil_wrt", "dih_wrt", "sil_wrt", "sih_wrt", "marl_wrt", "marh_wrt", "bpl_wrt", "bph_wrt", "pcl_wrt", "pch_wrt",
"spl_wrt", "sph_wrt", "-", "-", "int_vector_wrt", "mask_flags_wrt", "mar_in_src", "int_ack", "clear_all_ints", "ptb_wrt", "pagtbl_ram_we", "mdr_to_pagtbl_en",
"force_user_ptb", "-", "-", "-", "-", "gl_wrt", "gh_wrt", "imm_0", "imm_1", "imm_2", "imm_3", "imm_4", "imm_5", "imm_6", "imm_7", "-", "-", "-", "-", "-", "-", "-", "-"
	};

	//CLOCK LOW
	UADDRESSER(sol1_cpu, sol1_microcode, mccycle);
	if (DEBUG_MICROCODE) {
		printf("***** MICROCODE\n");
		//printf("U-ADDRESS: ");  print_word_bin(sol1_microcode->u_ad_bus); printf("\n");		
		//printf("OPCODE: %02x (cycle %02x)\n", (sol1_microcode->u_ad_bus / 64), (sol1_microcode->u_ad_bus % 64));
		//printf("microcode: \n");
		sol1_rom_display_current_cycles_desc(&sol1_cpu->rom, (sol1_microcode->u_ad_bus / 64), (sol1_microcode->u_ad_bus % 64));
		printf("* U_FLAGS="); print_byte_bin(sol1_register_8bit_value(sol1_microcode->U_FLAGS)); printf("\n");
		printf("******************************************************************************\n");
	}





	//eSOL1_DWORD microcode = 0x00;
	/*
	int i = 0;
	int j = 0;
	for (i = 0; i < 15; i++) {
		//microcode = microcode | (sol1_cpu->rom.roms[i][u_ad_bus] << (8 * i));

		if (DEBUG_MICROCODE && sol1_cpu->rom.roms[i][sol1_microcode->u_ad_bus] != 0x00) {
			for (j = 0; j < 8; j++)
			{
				if ((sol1_cpu->rom.roms[i][sol1_microcode->u_ad_bus] >> j) & 0x1 != 0) {
					printf("%s, ", SOL1_ROM_CONTROL_LIST[(i * 8) + j]);
				}

			}

		}
	}
	if (DEBUG_MICROCODE)
		printf("\n");
	*/
	//SOL1_BYTE opcode = u_ad_bus;
	//int cycle = 0;
	//int p = opcode * SOL1_ROM_CYCLES_PER_INSTR + cycle; <<<< u_ad_bus


	////////////////////////////////////////////////////////////////////////////

	mccycle->next = sol1_cpu->rom.roms[0][sol1_microcode->u_ad_bus] & 0b00000011;///////////////////////

	sol1_microcode->u_offset = ((sol1_cpu->rom.roms[1][sol1_microcode->u_ad_bus] & 0b00000001) << 6) |/////////
		((sol1_cpu->rom.roms[0][sol1_microcode->u_ad_bus] >> 2) & 0b00111111);////////////////////

	mccycle->cond_inv = (sol1_cpu->rom.roms[1][sol1_microcode->u_ad_bus] >> 1) & 0b00000001;
	mccycle->cond_flags_src = (sol1_cpu->rom.roms[1][sol1_microcode->u_ad_bus] >> 2) & 0b00000001;
	mccycle->cond_sel = (sol1_cpu->rom.roms[1][sol1_microcode->u_ad_bus] >> 3) & 0b00001111;
	sol1_microcode->u_esc_in_src = sol1_cpu->rom.roms[1][sol1_microcode->u_ad_bus] >> 7 & 0b00000001; //ESCAPE

	sol1_microcode->uzf_in_src = sol1_cpu->rom.roms[2][sol1_microcode->u_ad_bus] & 0b00000011;/////////////////
	sol1_microcode->ucf_in_src = (sol1_cpu->rom.roms[2][sol1_microcode->u_ad_bus] >> 2) & 0b00000011;//////////
	sol1_microcode->usf_in_src = (sol1_cpu->rom.roms[2][sol1_microcode->u_ad_bus] >> 4) & 0b00000001;//////////
	sol1_microcode->uof_in_src = (sol1_cpu->rom.roms[2][sol1_microcode->u_ad_bus] >> 5) & 0b00000001;//////////
	mccycle->ir_wrt = (sol1_cpu->rom.roms[2][sol1_microcode->u_ad_bus] >> 6) & 0b00000001;/////////////////
	mccycle->status_wrt = (sol1_cpu->rom.roms[2][sol1_microcode->u_ad_bus] >> 7) & 0b00000001;/////////////

	mccycle->shift_src = sol1_cpu->rom.roms[3][sol1_microcode->u_ad_bus] & 0b00000111;/////////////////////
	mccycle->zbus_out_src = (sol1_cpu->rom.roms[3][sol1_microcode->u_ad_bus] >> 3) & 0b00000011;///////////

	alu->alu_a_src = ((sol1_cpu->rom.roms[3][sol1_microcode->u_ad_bus] >> 5) & 0b00000111) | ///////
		((sol1_cpu->rom.roms[4][sol1_microcode->u_ad_bus] & 0b00000111) << 3);/////////////////////

	alu->alu_op = (sol1_cpu->rom.roms[4][sol1_microcode->u_ad_bus] >> 3) & 0b00001111;//////////////
	alu->alu_mode = (sol1_cpu->rom.roms[4][sol1_microcode->u_ad_bus] >> 7) & 0b00000001;////////////

	alu->alu_cf_in_src = (sol1_cpu->rom.roms[5][sol1_microcode->u_ad_bus]) & 0b00000011;////////////
	alu->alu_cf_in_inv = (sol1_cpu->rom.roms[5][sol1_microcode->u_ad_bus] >> 2) & 0b00000001;///////
	mccycle->zf_in_src = (sol1_cpu->rom.roms[5][sol1_microcode->u_ad_bus] >> 3) & 0b00000011;///////////////


	alu->alu_cf_out_inv = (sol1_cpu->rom.roms[5][sol1_microcode->u_ad_bus] >> 5) & 0b00000001;//////
	mccycle->cf_in_src = ((sol1_cpu->rom.roms[5][sol1_microcode->u_ad_bus] >> 6) & 0b00000011) |////////////
		((sol1_cpu->rom.roms[6][sol1_microcode->u_ad_bus] & 0b00000001) << 2);/////////////////////

	mccycle->sf_in_src = (sol1_cpu->rom.roms[6][sol1_microcode->u_ad_bus] >> 1) & 0b00000011;///////////////

	mccycle->of_in_src = (sol1_cpu->rom.roms[6][sol1_microcode->u_ad_bus] >> 3) & 0b00000111;///////////////

	mccycle->rd = (sol1_cpu->rom.roms[6][sol1_microcode->u_ad_bus] >> 6) & 0b00000001;//////////////////////
	mccycle->wr = (sol1_cpu->rom.roms[6][sol1_microcode->u_ad_bus] >> 7) & 0b00000001;//////////////////////

	alu->alu_b_src = sol1_cpu->rom.roms[7][sol1_microcode->u_ad_bus] & 0b00000111;//////////////////

	mccycle->display_reg_load = (sol1_cpu->rom.roms[7][sol1_microcode->u_ad_bus] >> 3) & 0b00000001;////
	mccycle->dl_wrt = (sol1_cpu->rom.roms[7][sol1_microcode->u_ad_bus] >> 4) & 0b00000001;//////////////
	mccycle->dh_wrt = (sol1_cpu->rom.roms[7][sol1_microcode->u_ad_bus] >> 5) & 0b00000001;//////////////
	mccycle->cl_wrt = (sol1_cpu->rom.roms[7][sol1_microcode->u_ad_bus] >> 6) & 0b00000001;//////////////
	mccycle->ch_wrt = (sol1_cpu->rom.roms[7][sol1_microcode->u_ad_bus] >> 7) & 0b00000001;//////////////
	mccycle->bl_wrt = (sol1_cpu->rom.roms[8][sol1_microcode->u_ad_bus] >> 0) & 0b00000001;//////////////
	mccycle->bh_wrt = (sol1_cpu->rom.roms[8][sol1_microcode->u_ad_bus] >> 1) & 0b00000001;//////////////
	mccycle->al_wrt = (sol1_cpu->rom.roms[8][sol1_microcode->u_ad_bus] >> 2) & 0b00000001;//////////////
	mccycle->ah_wrt = (sol1_cpu->rom.roms[8][sol1_microcode->u_ad_bus] >> 3) & 0b00000001;//////////////
	mccycle->mdr_in_src = (sol1_cpu->rom.roms[8][sol1_microcode->u_ad_bus] >> 4) & 0b00000001;//////////
	mccycle->mdr_out_src = (sol1_cpu->rom.roms[8][sol1_microcode->u_ad_bus] >> 5) & 0b00000001;/////////
	mccycle->mdr_out_en = (sol1_cpu->rom.roms[8][sol1_microcode->u_ad_bus] >> 6) & 0b00000001;//////////
	mccycle->mdrl_wrt = (sol1_cpu->rom.roms[8][sol1_microcode->u_ad_bus] >> 7) & 0b00000001;////////////
	mccycle->mdrh_wrt = (sol1_cpu->rom.roms[9][sol1_microcode->u_ad_bus] >> 0) & 0b00000001;////////////
	mccycle->tdrl_wrt = (sol1_cpu->rom.roms[9][sol1_microcode->u_ad_bus] >> 1) & 0b00000001;////////////
	mccycle->tdrh_wrt = (sol1_cpu->rom.roms[9][sol1_microcode->u_ad_bus] >> 2) & 0b00000001;////////////
	mccycle->dil_wrt = (sol1_cpu->rom.roms[9][sol1_microcode->u_ad_bus] >> 3) & 0b00000001;/////////////
	mccycle->dih_wrt = (sol1_cpu->rom.roms[9][sol1_microcode->u_ad_bus] >> 4) & 0b00000001;/////////////
	mccycle->sil_wrt = (sol1_cpu->rom.roms[9][sol1_microcode->u_ad_bus] >> 5) & 0b00000001;/////////////
	mccycle->sih_wrt = (sol1_cpu->rom.roms[9][sol1_microcode->u_ad_bus] >> 6) & 0b00000001;/////////////
	mccycle->marl_wrt = (sol1_cpu->rom.roms[9][sol1_microcode->u_ad_bus] >> 7) & 0b00000001;////////////
	mccycle->marh_wrt = (sol1_cpu->rom.roms[10][sol1_microcode->u_ad_bus] >> 0) & 0b00000001;///////////
	mccycle->bpl_wrt = (sol1_cpu->rom.roms[10][sol1_microcode->u_ad_bus] >> 1) & 0b00000001;////////////
	mccycle->bph_wrt = (sol1_cpu->rom.roms[10][sol1_microcode->u_ad_bus] >> 2) & 0b00000001;////////////
	mccycle->pcl_wrt = (sol1_cpu->rom.roms[10][sol1_microcode->u_ad_bus] >> 3) & 0b00000001;////////////
	mccycle->pch_wrt = (sol1_cpu->rom.roms[10][sol1_microcode->u_ad_bus] >> 4) & 0b00000001;////////////
	mccycle->spl_wrt = (sol1_cpu->rom.roms[10][sol1_microcode->u_ad_bus] >> 5) & 0b00000001;////////////
	mccycle->sph_wrt = (sol1_cpu->rom.roms[10][sol1_microcode->u_ad_bus] >> 6) & 0b00000001;////////////

	mccycle->int_vector_wrt = (sol1_cpu->rom.roms[11][sol1_microcode->u_ad_bus] >> 1) & 0b00000001;/////
	mccycle->mask_flags_wrt = (sol1_cpu->rom.roms[11][sol1_microcode->u_ad_bus] >> 2) & 0b00000001;/////
	mccycle->mar_in_src = (sol1_cpu->rom.roms[11][sol1_microcode->u_ad_bus] >> 3) & 0b00000001;/////////
	mccycle->int_ack = (sol1_cpu->rom.roms[11][sol1_microcode->u_ad_bus] >> 4) & 0b00000001;
	mccycle->clear_all_ints = (sol1_cpu->rom.roms[11][sol1_microcode->u_ad_bus] >> 5) & 0b00000001;
	mccycle->ptb_wrt = (sol1_cpu->rom.roms[11][sol1_microcode->u_ad_bus] >> 6) & 0b00000001;////////////
	mccycle->pagtbl_ram_we = (sol1_cpu->rom.roms[11][sol1_microcode->u_ad_bus] >> 7) & 0b00000001;//////
	mccycle->mdr_to_pagtbl_en = (sol1_cpu->rom.roms[12][sol1_microcode->u_ad_bus] >> 0) & 0b00000001;///
	mccycle->force_user_ptb = (sol1_cpu->rom.roms[12][sol1_microcode->u_ad_bus] >> 1) & 0b00000001;

	mccycle->gl_wrt = (sol1_cpu->rom.roms[12][sol1_microcode->u_ad_bus] >> 6) & 0b00000001;/////////////
	mccycle->gh_wrt = (sol1_cpu->rom.roms[12][sol1_microcode->u_ad_bus] >> 7) & 0b00000001;/////////////

	mccycle->imm = sol1_cpu->rom.roms[13][sol1_microcode->u_ad_bus]; ///////////////////////////////////

}






void mc_sequencer(
	sol1_cpu *sol1_cpu,
	sol1_alu_8bit *alu,
	sol1_microcode *sol1_microcode,
	struct bus *bus,
	struct mccycle *mccycle,
	SOL1_BYTE *memchip0,
	SOL1_BYTE *memchip1,
	long *runtime_counter
) {

	//boot sequence:
//bios, boot, kernel, shell
	while (1) {


		//printf("#################################################################################\n");
		//printf("# Runtime Counter: %d\n", (*runtime_counter)++);
		//printf("#################################################################################\n");


		////////////////////////////////////////////////////////////////////////////
		mc_seq_update(sol1_cpu,
			alu,
			sol1_microcode,
			mccycle);




		if (!(sol1_cpu->rom.bkpt_opcode == 0 && sol1_cpu->rom.bkpt_cycle == 0) &&
			((sol1_microcode->u_ad_bus / 64) == sol1_cpu->rom.bkpt_opcode &&
			(sol1_microcode->u_ad_bus % 64) == sol1_cpu->rom.bkpt_cycle))
		{
			printf(" Microcode Breakpoint | Starting Opcode/Cycle:%02x%02x.\n", sol1_cpu->rom.bkpt_opcode, sol1_cpu->rom.bkpt_cycle);
			debugmenu_main(sol1_cpu);
		}


		////////////////////////////////////////////////////////////////////////////
		// MEMORY READ
		/*
		SOL1_BYTE inMdrMux00 = IC_74LS157(z_bus & 0b00001111, data_bus & 0b00001111, mdr_in_src); //IC7
		SOL1_BYTE inMdrMux01 = IC_74LS157((z_bus >> 4) & 0b00001111, (data_bus >> 4) & 0b00001111, mdr_in_src); //IC24
		SOL1_BYTE inMdrMux_res = inMdrMux00 | (inMdrMux01 << 4);

		SOL1_BYTE inMdr00 = IC_74LS377(sol1_cpu->memory.MDRl, inMdrMux_res, 0x1, mdrl_wrt); //IC19
		SOL1_BYTE inMdr01 = IC_74LS377(sol1_cpu->memory.MDRh, inMdrMux_res, 0x1, mdrh_wrt); //183

		SOL1_BYTE inMdrDataOut00 = IC_74LS157(inMdr00 & 0b00001111, inMdr01 & 0b00001111,
			(((~mdr_out_en) & 0b00000001) << 1) | (mdr_out_src));

		SOL1_BYTE inMdrDataOut01 = IC_74LS157(((inMdr00 & 0b11110000) >> 4), ((inMdr01 & 0b11110000) >> 4),
			(((~mdr_out_en) & 0b00000001) << 1) | (mdr_out_src));

		data_bus = (inMdrDataOut00 & 0b00001111) | ((inMdrDataOut00 & 0b00001111) << 4);
		*/

		if (mccycle->mdr_out_en != 0x00 && mccycle->mdr_out_src == 0x00)
			bus->data_bus = sol1_register_8bit_value(sol1_cpu->memory.MDRl);
		else if (mccycle->mdr_out_en != 0x00 && mccycle->mdr_out_src != 0x00)
			bus->data_bus = sol1_register_8bit_value(sol1_cpu->memory.MDRh);

		//244 MICROCODE SIGNALS NEED
		//INVERTER BECAUSE THEY GET RESET TO
		//ZERO AT BEGINNING, AND 244 ARE LOW ACTIVE.
		//THIS CAUSES PROBLEMS ON RESET.




		////////////////////////////////////////////////////////////////////////////

		SOL1_BYTE inIC18A = IC_74LS32(0x00, mccycle->int_pending & 0b00000001);
		SOL1_BYTE inIC18B = IC_74LS32(inIC18A & 0b00000001, mccycle->dma_req);
		mccycle->any_interruption = inIC18B & 0b00000001;

		SOL1_BYTE inIC22A = IC_74LS08(mccycle->int_request & 0b00000001, get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_interrupt_enable));
		mccycle->int_pending = inIC22A & 0b00000001;

		SOL1_BYTE inIC18C = IC_74LS32(mccycle->force_user_ptb & 0b00000001, get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_cpu_mode));
		mccycle->page_table_addr_src = inIC18C & 0b00000001;



		////////////////////////////////////////////////////////////////////////////

		////////////////////////////////////////////////////////////////////////////
		// MEMORY PAGE


		SOL1_BYTE inPTB = IC_74LS377(sol1_cpu->registers.PTB, bus->z_bus, 0x1, mccycle->ptb_wrt); //IC66

		SOL1_BYTE inPTB00 = IC_74LS257(0x00, inPTB & 0b00001111, mccycle->page_table_addr_src); //IC142
		SOL1_BYTE inPTB01 = IC_74LS257(0x00, (inPTB >> 4) & 0b00001111, mccycle->page_table_addr_src); //IC147

		/////
		SOL1_MWORD ptb_mem_addr = ((sol1_register_8bit_value(sol1_cpu->memory.MARh) >> 3) & 0b00011111) |
			((inPTB00 & 0b00001111) << 5) |
			((inPTB01 & 0b00001111) << 9);

		SOL1_BYTE ptb_mem_we = IC_74LS04(mccycle->pagtbl_ram_we); //IC138D
		SOL1_BYTE ptb_mem_oe = mccycle->mdr_to_pagtbl_en;
		SOL1_BYTE ptb_mem_ce = 0x00; // sempre enable ? force_user_ptb??

		SOL1_BYTE ptb_mem_0 = 0x00;
		SOL1_BYTE ptb_mem_1 = 0x00;
		/////

		SOL1_BYTE inMemTristate_oe = IC_74LS04(mccycle->mdr_to_pagtbl_en);

		SOL1_BYTE inMemTristate_00 = IC_74LS244(sol1_register_8bit_value(sol1_cpu->memory.MDRl) & 0b00001111, inMemTristate_oe); //IC97A
		SOL1_BYTE inMemTristate_01 = IC_74LS244((sol1_register_8bit_value(sol1_cpu->memory.MDRl) >> 4) & 0b00001111, inMemTristate_oe); //IC97B
		SOL1_BYTE inMemTristate_10 = IC_74LS244(sol1_register_8bit_value(sol1_cpu->memory.MDRh) & 0b00001111, inMemTristate_oe); //IC185A
		SOL1_BYTE inMemTristate_11 = IC_74LS244((sol1_register_8bit_value(sol1_cpu->memory.MDRh) >> 4) & 0b00001111, inMemTristate_oe); //IC185B

		if ((inMemTristate_oe & 0x01) == 0x00) {
			ptb_mem_0 = (inMemTristate_00 & 0b00001111) | ((inMemTristate_01 & 0b00001111) << 4);
			ptb_mem_1 = (inMemTristate_10 & 0b00001111) | ((inMemTristate_11 & 0b00001111) << 4);
		}

		/////MEMORIA AQUI
		// ~oe = output enabled
		// ~we = write enabled
		// ~ce = chip enabled
		if ((ptb_mem_ce & 0x01) == 0x00) { // chip enabled
			if ((ptb_mem_we & 0x01) == 0x00) { // write enabled
				memchip0[ptb_mem_addr] = ptb_mem_0; //IC140
				memchip1[ptb_mem_addr] = ptb_mem_1; //IC141
			}
			if ((ptb_mem_oe & 0x01) == 0x00) { // output enabled
				ptb_mem_0 = memchip0[ptb_mem_addr]; //IC140
				ptb_mem_1 = memchip1[ptb_mem_addr]; //IC141
			}
		}

		SOL1_BYTE inMswPaging_0 = IC_74LS257( //IC114
			(sol1_register_8bit_value(sol1_cpu->memory.MARh) >> 3) & 0b00001111,
			ptb_mem_0 & 0b00001111,
			get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_paging_en));

		SOL1_BYTE inMswPaging_1 = IC_74LS257( //IC112
			((sol1_register_8bit_value(sol1_cpu->memory.MARh) >> 7) & 0b00000001),
			(ptb_mem_0 >> 4) & 0b00001111,
			get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_paging_en));

		SOL1_BYTE inMswPaging_2 = IC_74LS257( //IC39
			0b00001000,
			ptb_mem_1 & 0b00001111,
			get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_paging_en));

		SOL1_BYTE inMswPaging_3 = IC_74LS257( //104
			0b00000011,
			(ptb_mem_1 >> 4) & 0b00001111,
			get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_paging_en));

		//
		/*
		SOL1_BYTE inBusTristate_00 = IC_74LS244(sol1_register_8bit_value(sol1_cpu->memory.MARl) & 0b00001111, mccycle->bus_tristate);  //IC4A
		SOL1_BYTE inBusTristate_01 = IC_74LS244((sol1_register_8bit_value(sol1_cpu->memory.MARl) >> 4) & 0b00001111, mccycle->bus_tristate); //IC4B

		SOL1_BYTE inBusTristate_10 = IC_74LS244((sol1_register_8bit_value(sol1_cpu->memory.MARl) & 0b00000111) | ((inMswPaging_0 & 0b00000001) << 3), mccycle->bus_tristate); //IC26A
		SOL1_BYTE inBusTristate_11 = IC_74LS244(((inMswPaging_0 & 0b00001110) >> 1) | ((inMswPaging_1 & 0b00000001) << 3), mccycle->bus_tristate); //IC26B

		SOL1_BYTE inBusTristate_20 = IC_74LS244(((inMswPaging_1 & 0b00001110) >> 1) | ((inMswPaging_2 & 0b00000001) << 3), mccycle->bus_tristate); //IC65A
		SOL1_BYTE inBusTristate_21 = IC_74LS244(((inMswPaging_2 & 0b00001110) >> 1) | ((inMswPaging_3 & 0b00000001) << 3), mccycle->bus_tristate); //IC65B

		SOL1_BYTE inBusTristate_30 = IC_74LS244((inMswPaging_3 & 0b00001110) >> 1, mccycle->bus_tristate); //IC72A


		bus->address_bus = ((unsigned long)(inBusTristate_00 & 0b00001111)) |
			(((unsigned long)(inBusTristate_01 & 0b00001111)) << 4) |
			(((unsigned long)(inBusTristate_10 & 0b00001111)) << 8) |
			(((unsigned long)(inBusTristate_11 & 0b00001111)) << 12) |
			(((unsigned long)(inBusTristate_20 & 0b00001111)) << 16) |
			(((unsigned long)(inBusTristate_21 & 0b00000011)) << 20);
		*/







		////////////////////////////////////////////////////////////////////////////

		if (get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_paging_en) == 0x00 || buffer_mem_io(sol1_cpu, mccycle) == 0x01) {
			if (buffer_rd(sol1_cpu, mccycle) == 0x00) {
				unsigned long mem_addr = read_address_bus(sol1_cpu);

				bus->data_bus = sol1_cpu->memory.memory[mem_addr];// bus->address_bus & 0b0111111111111111];
				//if (mem_addr >= 0xFF80) {
				if (mem_addr >= 0xF7FF) {
					printf("read %x\t%c\n", mem_addr, bus->data_bus);
				}
			}

			//else if (mccycle->buffer_wr == 0x00)
			//	sol1_cpu->memory.memory[bus->address_bus & 0b0111111111111111] = bus->data_bus;
		}

		////////////////////////////////////////////////////////////////////////////
		// W = X
		bus->w_bus = refresh_w_bus(mccycle->panel_regsel,
			alu->alu_a_src, mccycle->display_reg_load,
			mccycle->int_vector, mccycle->int_mask, mccycle->int_status,
			sol1_cpu);

		////////////////////////////////////////////////////////////////////////////
		// K = Y
		bus->k_bus = refresh_k_bus(alu->alu_b_src, sol1_cpu);
		////////////////////////////////////////////////////////////////////////////
		/*
		SOL1_BYTE IC184_TEMPl = sol1_register_8bit_value(sol1_cpu->registers.Gl); // IC_74LS377(sol1_cpu->registers.Gl, data_bus, 0x01, 0x0); //IC184
		SOL1_BYTE IC204_TEMPh = sol1_register_8bit_value(sol1_cpu->registers.Gh); //IC_74LS377(sol1_cpu->registers.Gh, data_bus, 0x01, 0x0); //IC204

		SOL1_BYTE inIC170_A = (MSW_ZF & 0b00000001) |
			((msw_dma_ack & 0b00000001) << 1) |
			((IC184_TEMPl & 0b00000001) << 2) |
			((IC204_TEMPh & 0b00000001) << 3);

		SOL1_BYTE inIC170_B = (MSW_CF & 0b00000001) |
			((msw_interrupt_enable & 0b00000001) << 1) |
			((get_byte_bit(IC184_TEMPl, 1) & 0b00000001) << 2) |
			((get_byte_bit(IC204_TEMPh, 1) & 0b00000001) << 3);


		SOL1_BYTE inTMP0_IC170 = IC_74LS253(inIC170_A, inIC170_B, alu->alu_a_src & 0b00000011, 0x0); //IC170

		SOL1_BYTE inIC179_A = (MSW_SF & 0b00000001) |
			((msw_cpu_mode & 0b00000001) << 1) |
			((get_byte_bit(IC184_TEMPl, 2) & 0b00000001) << 2) |
			((get_byte_bit(IC204_TEMPh, 2) & 0b00000001) << 3);

		SOL1_BYTE inIC179_B = (MSW_OF & 0b00000001) |
			((msw_paging_en & 0b00000001) << 1) |
			((get_byte_bit(IC184_TEMPl, 3) & 0b00000001) << 2) |
			((get_byte_bit(IC204_TEMPh, 3) & 0b00000001) << 3);


		SOL1_BYTE inTMP1_IC179 = IC_74LS253(inIC179_A, inIC179_B, alu->alu_a_src & 0b00000011, 0x0); //IC179




		SOL1_BYTE inIC181_A = (MSW_12 & 0b00000001) |
			((msw_halt & 0b00000001) << 1) |
			((get_byte_bit(IC184_TEMPl, 4) & 0b00000001) << 2) |
			((get_byte_bit(IC204_TEMPh, 4) & 0b00000001) << 3);

		SOL1_BYTE inIC181_B = (MSW_13 & 0b00000001) |
			((msw_display_reg_load & 0b00000001) << 1) |
			((get_byte_bit(IC184_TEMPl, 5) & 0b00000001) << 2) |
			((get_byte_bit(IC204_TEMPh, 5) & 0b00000001) << 3);


		SOL1_BYTE inTMP2_IC181 = IC_74LS253(inIC181_A, inIC181_B, alu->alu_a_src & 0b00000011, 0x0); //IC181


		SOL1_BYTE inIC182_A = (MSW_14 & 0b00000001) |
			((MSW_14 & 0b00000001) << 1) |
			((get_byte_bit(IC184_TEMPl, 6) & 0b00000001) << 2) |
			((get_byte_bit(IC204_TEMPh, 6) & 0b00000001) << 3);

		SOL1_BYTE inIC182_B = (MSW_15 & 0b00000001) |
			((msw_dir & 0b00000001) << 1) |
			((get_byte_bit(IC184_TEMPl, 7) & 0b00000001) << 2) |
			((get_byte_bit(IC204_TEMPh, 7) & 0b00000001) << 3);

		SOL1_BYTE inTMP3_IC182 = IC_74LS253(inIC182_A, inIC182_B, alu->alu_a_src & 0b00000011, 0x0); //IC182

		SOL1_BYTE inTMP = (inTMP0_IC170 & 0b00000011) | ((inTMP1_IC179 & 0b00000011) << 2) |
			((inTMP2_IC181 & 0b00000011) << 4) | ((inTMP3_IC182 & 0b00000011) << 6);



		////////////////////////////////////////////////////////////////////////////

		SOL1_BYTE inWX0_IC1 = IC_74LS257(w_bus & 0b00001111, //IC1
			(inTMP0_IC170 & 0b00000011) | ((inTMP1_IC179 & 0b00000011) << 2),
			get_byte_bit(alu->alu_a_src, 5));

		SOL1_BYTE inWX1_IC13 = IC_74LS257((w_bus & 0b11110000) >> 4, //IC13
			(inTMP2_IC181 & 0b00000011) | ((inTMP3_IC182 & 0b00000011) << 2),
			get_byte_bit(alu->alu_a_src, 5));

		x_bus = (inWX0_IC1 & 0b00001111) | ((inWX1_IC13 & 0b00001111) << 4);
		*/

		if (get_byte_bit(alu->alu_a_src, 5) == 0x00)
			bus->x_bus = bus->w_bus;
		else {

			switch ((alu->alu_a_src & 0b00000011)) {
			case 0x00:

				bus->x_bus = set_byte_bit(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_ZF), 0) |
					set_byte_bit(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_CF), 1) |
					set_byte_bit(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_SF), 2) |
					set_byte_bit(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_OF), 3) |
					set_byte_bit(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_12), 4) |
					set_byte_bit(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_13), 5) |
					set_byte_bit(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_14), 6) |
					set_byte_bit(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_15), 7);
				break;

			case 0x01:

				bus->x_bus = get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_dma_ack) |
					set_byte_bit(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_interrupt_enable), 1) |
					set_byte_bit(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_cpu_mode), 2) |
					set_byte_bit(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_paging_en), 3) |
					set_byte_bit(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_halt), 4) |
					set_byte_bit(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_display_reg_load), 5) |
					set_byte_bit(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_14), 6) |
					set_byte_bit(get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_dir), 7);
				break;

			case 0x02:
				bus->x_bus = sol1_register_8bit_value(sol1_cpu->registers.Gl);
				break;

			case 0x03:
				bus->x_bus = sol1_register_8bit_value(sol1_cpu->registers.Gh);
				break;
			}
		}

		////////////////////////////////////////////////////////////////////////////
		/*
		SOL1_BYTE inKY0_IC98 = IC_74LS257(imm & 0b00001111, //IC98
			k_bus & 0b00001111,
			get_byte_bit(alu->alu_b_src, 2));

		SOL1_BYTE inKY1_IC22 = IC_74LS257((imm & 0b11110000) >> 4, //IC22
			(k_bus & 0b11110000) >> 4,
			get_byte_bit(alu->alu_b_src, 2));

		y_bus = (inKY0_IC98 & 0b00001111) | ((inKY1_IC22 & 0b00001111) << 4);
		*/
		bus->y_bus = (alu->alu_b_src == 0x00) ? mccycle->imm : bus->k_bus;

		////////////////////////////////////////////////////////////////////////////
		// ALU

		bus->z_bus = ALU_EXEC(alu, bus->x_bus, bus->y_bus,
			alu->alu_op,
			alu->alu_mode,
			alu->alu_cf_in_src,
			alu->alu_cf_in_inv,
			alu->alu_cf_out_inv,
			sol1_microcode->u_cf,
			get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), MSW_CF),
			mccycle->shift_src,
			mccycle->zbus_out_src);

		////////////////////////////////////////////////////////////////////////////
		sol1_u_flags(alu, sol1_microcode, mccycle->imm, bus->z_bus);
		if (DEBUG_UFLAGS) {
			printf("***** U_FLAGS\n");
			sol1_microcode_display_u_flags(sol1_microcode);
			printf("******************************************************************************\n");
		}

		//#######################
		if (get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWl), msw_paging_en) == 0x00 || buffer_mem_io(sol1_cpu, mccycle) == 0x01) {
			if (buffer_wr(sol1_cpu, mccycle) == 0x00) {
				unsigned long mem_addr = read_address_bus(sol1_cpu);
				//if (mem_addr >= 0xFF80) {
				//printf("write %x\t%c\n", mem_addr, bus->data_bus);
				//}
				//sol1_cpu->memory.memory[read_address_bus(sol1_cpu)] = bus->data_bus;
				sol1_cpu->memory.memory[mem_addr] = bus->data_bus;
			}
		}
		//#######################


		/*
		SOL1_BYTE inIC86B = IC_74LS86(alu->alu_cf_out_inv & 0b00000001, alu->alu_cf & 0b00000001); //IC86B
		alu->alu_final_cf = inIC86B & 0b00000001;

		SOL1_BYTE inIC58B = IC_74LS11(alu->alu_zf, 0x01, get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_ZF)); //IC58B
		SOL1_BYTE inIC86C = IC_74LS86(sol1_microcode->u_sf & 0b00000001, get_byte_bit(bus->z_bus, 7)); //IC86C


		SOL1_BYTE inMSW0_A = get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_ZF) | (alu->alu_zf << 1) | ((inIC58B & 0b00000001) << 2) | ((bus->z_bus & 0b00000001) << 3);
		SOL1_BYTE inMSW0_IC241 = IC_74LS153(inMSW0_A, 0x00, mccycle->zf_in_src & 0b00000011, 0x00); //IC241

		SOL1_BYTE inMSW1 = get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_CF) | (alu->alu_final_cf << 1) | ((bus->z_bus & 0b00000001) << 2) | (get_byte_bit(bus->z_bus, 1) << 3) | (get_byte_bit(bus->z_bus, 7) << 4);
		SOL1_BYTE inMSW1_IC14 = IC_74LS151(inMSW1, mccycle->cf_in_src & 0b00000111, 0x00); //IC14

		SOL1_BYTE inMSW2_A = get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_SF) | (get_byte_bit(bus->z_bus, 7) << 1) | (get_byte_bit(bus->z_bus, 2) << 3);
		SOL1_BYTE inMSW2_IC255 = IC_74LS153(inMSW2_A, 0x00, mccycle->sf_in_src & 0b00000011, 0x00); //IC255

		SOL1_BYTE inMSW3 = get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_OF) | (alu->alu_of << 1) | (get_byte_bit(bus->z_bus, 7) << 2) | (get_byte_bit(bus->z_bus, 3) << 3) | ((inIC86C & 0b00000001) << 4);
		SOL1_BYTE inMSW3_IC23 = IC_74LS151(inMSW3, mccycle->of_in_src & 0b00000111, 0x00); //IC23

		SOL1_BYTE inMSW_RES_A = get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_12) | (get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_13) << 1) | (get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_14) << 2) | (get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_15) << 3);
		SOL1_BYTE inMSW_RES_B = get_byte_bit(bus->z_bus, 4) | (get_byte_bit(bus->z_bus, 5) << 1) | (get_byte_bit(bus->z_bus, 6) << 2) | (get_byte_bit(bus->z_bus, 7) << 3);

		SOL1_BYTE inMSW_RES_IC206 = IC_74LS257(inMSW_RES_A, inMSW_RES_B, 0x01);// mswh_wrt);

		SOL1_BYTE inMSW_H = (inMSW0_IC241 & 0b00000001) | ((inMSW1_IC14 & 0b00000001) << 1) | ((inMSW2_IC255 & 0b00000001) << 2) | ((inMSW3_IC23 & 0b00000001) << 3) | ((inMSW_RES_IC206 & 0b00001111) << 4);

		SOL1_BYTE rMSW_H = IC_74LS273(sol1_cpu->registers.MSWh, inMSW_H, 0x01, 0x01);//clk, ~rst
		//mccycle->MSW_ZF = rMSW_H & 0b00000001;
		//mccycle->MSW_CF = get_byte_bit(rMSW_H, 1);
		//mccycle->MSW_SF = get_byte_bit(rMSW_H, 2);
		//mccycle->MSW_OF = get_byte_bit(rMSW_H, 3);
		//mccycle->MSW_12 = get_byte_bit(rMSW_H, 4);
		//mccycle->MSW_13 = get_byte_bit(rMSW_H, 5);
		//mccycle->MSW_14 = get_byte_bit(rMSW_H, 6);
		// mccycle->MSW_15 = get_byte_bit(rMSW_H, 7);
		*/

		//
		SOL1_BYTE inMSWh_ZF = refresh_MSWh_ZF(sol1_cpu, alu, bus->z_bus, mccycle->zf_in_src);
		SOL1_BYTE inMSWh_CF = refresh_MSWh_CF(sol1_cpu, alu, bus->z_bus, mccycle->cf_in_src);
		SOL1_BYTE inMSWh_SF = refresh_MSWh_SF(sol1_cpu, alu, bus->z_bus, mccycle->sf_in_src);
		SOL1_BYTE inMSWh_OF = refresh_MSWh_OF(sol1_cpu, alu, bus->z_bus, sol1_microcode->u_sf, mccycle->of_in_src);

		//

		if (0x01) { // ~RST

			SOL1_BYTE inMSW_H = set_byte_bit(inMSWh_ZF, 0) | set_byte_bit(inMSWh_CF, 1) | set_byte_bit(inMSWh_SF, 2) | set_byte_bit(inMSWh_OF, 3);

			/*
			SOL1_BYTE inMSW_H2 = 0x00;
			if (mswh_wrt == 0x00)
				inMSW_H2 = (get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_12) & 0b00000001) |
				(((get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_13) & 0b00000001) & 0b00000001) << 1) |
				(((get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_14) & 0b00000001) & 0b00000001) << 2) |
				(((get_byte_bit(sol1_register_8bit_value(sol1_cpu->registers.MSWh), MSW_15) & 0b00000001) & 0b00000001) << 3);
			else
				inMSW_H2 = (get_byte_bit(bus->z_bus, 4) & 0b00000001) |
				(((get_byte_bit(bus->z_bus, 5) & 0b00000001) & 0b00000001) << 1) |
				(((get_byte_bit(bus->z_bus, 6) & 0b00000001) & 0b00000001) << 2) |
				(((get_byte_bit(bus->z_bus, 7) & 0b00000001) & 0b00000001) << 3);
			inMSW_H = inMSW_H | inMSW_H2 << 4;
			*/

			//SOL1_BYTE inMSW_RES_IC206 = IC_74LS257(inMSW_RES_A, inMSW_RES_B, 0x01);// mswh_wrt);
			sol1_register_8bit_set(sol1_cpu->registers.MSWh, inMSW_H);
		}

		///
		//SOL1_BYTE rMSW_L = IC_74LS377(sol1_cpu->registers.MSWl, bus->z_bus, 0x01, mccycle->status_wrt);//clk
		//mccycle->msw_dma_ack = rMSW_L & 0b00000001;
		//mccycle->msw_interrupt_enable = get_byte_bit(rMSW_L, 1);
		//mccycle->msw_cpu_mode = get_byte_bit(rMSW_L, 2);
		//mccycle->msw_paging_en = get_byte_bit(rMSW_L, 3);
		//mccycle->msw_halt = get_byte_bit(rMSW_L, 4);
		//mccycle->msw_display_reg_load = get_byte_bit(rMSW_L, 5);
		//mccycle->MSW_14 = get_byte_bit(rMSW_L, 6);
		//mccycle->msw_dir = get_byte_bit(rMSW_L, 7);
		if (mccycle->status_wrt == 0x00) {
			sol1_register_8bit_set(sol1_cpu->registers.MSWl, bus->z_bus);
		}

		///////////////////////////////////////////////////////////////////////////
		//SOL1_BYTE clk = 0x1;
		//SOL1_BYTE rst = 0x1;
		//ir = IC_74LS377(reg_ir, data_bus, 0x1, ir_wrt); //clk IC28
		if (mccycle->ir_wrt == 0x00)
			sol1_register_8bit_set(sol1_microcode->IR, bus->data_bus);

		///////////////////////////////////////////////////////////////////////////
		// READ DATA
		//DATA REGISTERS
		if (mccycle->ah_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.Ah, bus->z_bus);
		if (mccycle->al_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.Al, bus->z_bus);

		if (mccycle->bh_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.Bh, bus->z_bus);
		if (mccycle->bl_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.Bl, bus->z_bus);

		if (mccycle->ch_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.Ch, bus->z_bus);
		if (mccycle->cl_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.Cl, bus->z_bus);

		if (mccycle->dh_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.Dh, bus->z_bus);
		if (mccycle->dl_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.Dl, bus->z_bus);

		if (mccycle->gh_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.Gh, bus->z_bus);
		if (mccycle->gl_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.Gl, bus->z_bus);

		//Pointer Registers
		if (mccycle->bph_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.BPh, bus->z_bus);
		if (mccycle->bpl_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.BPl, bus->z_bus);

		if (mccycle->sph_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.SPh, bus->z_bus);
		if (mccycle->spl_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.SPl, bus->z_bus);

		if (mccycle->ssph_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.SSPh, bus->z_bus);
		if (mccycle->sspl_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.SSPl, bus->z_bus);

		//Index Registers
		if (mccycle->sih_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.SIh, bus->z_bus);
		if (mccycle->sil_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.SIl, bus->z_bus);

		if (mccycle->dih_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.DIh, bus->z_bus);
		if (mccycle->dil_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.DIl, bus->z_bus);

		if (mccycle->pch_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.PCh, bus->z_bus);
		if (mccycle->pcl_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.PCl, bus->z_bus);

		if (mccycle->tdrh_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.TDRh, bus->z_bus);
		if (mccycle->tdrl_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.TDRl, bus->z_bus);

		//if (ptb_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->registers.PTB, z_bus);
	/////////////////////////////////////////////////////////////////////////////
	// SET MDR
		/*
	SOL1_BYTE inMdrMux00 = IC_74LS157(z_bus & 0b00001111, bus->data_bus & 0b00001111, mdr_in_src); //IC7
	SOL1_BYTE inMdrMux01 = IC_74LS157((z_bus >> 4) & 0b00001111, (bus->data_bus >> 4) & 0b00001111, mdr_in_src); //IC24
	SOL1_BYTE inMdrMux_res = inMdrMux00 | (inMdrMux01 << 4);

	SOL1_BYTE inMdr00 = IC_74LS377(sol1_cpu->memory.MDRl, inMdrMux_res, 0x1, mdrl_wrt); //IC19
	SOL1_BYTE inMdr01 = IC_74LS377(sol1_cpu->memory.MDRh, inMdrMux_res, 0x1, mdrh_wrt); //183
	*/

		if (mccycle->mdrl_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->memory.MDRl, mccycle->mdr_in_src == 0x00 ? bus->z_bus : bus->data_bus);
		if (mccycle->mdrh_wrt == 0x00) sol1_register_8bit_set(sol1_cpu->memory.MDRh, mccycle->mdr_in_src == 0x00 ? bus->z_bus : bus->data_bus);


		////////////////////////////////////////////////////////////////////////////
		//MEMORY SET MAR

		if (mccycle->marl_wrt == 0x00) {
			/*
			SOL1_BYTE IC131 = IC_74LS157((z_bus & 0b00001111), //IC131
				(sol1_register_8bit_value(sol1_cpu->registers.PCl) & 0b00001111),
				mar_in_src);

			SOL1_BYTE IC128 = IC_74LS157(((z_bus >> 4) & 0b00001111), //IC128
				((sol1_register_8bit_value(sol1_cpu->registers.PCl) >> 4) & 0b00001111),
				mar_in_src);

			sol1_register_8bit_set(sol1_cpu->memory.MARl, IC131 | (IC128 << 4));
			*/
			if (mccycle->mar_in_src == 0x00)
				sol1_register_8bit_set(sol1_cpu->memory.MARl, bus->z_bus);
			else
				sol1_register_8bit_set(sol1_cpu->memory.MARl, sol1_register_8bit_value(sol1_cpu->registers.PCl));
		}

		if (mccycle->marh_wrt == 0x00) {
			/*
			SOL1_BYTE IC129 = IC_74LS157((z_bus & 0b00001111), //IC129
				(sol1_register_8bit_value(sol1_cpu->registers.PCh) & 0b00001111),
				mar_in_src);

			SOL1_BYTE IC132 = IC_74LS157(((z_bus >> 4) & 0b00001111), //IC132
				((sol1_register_8bit_value(sol1_cpu->registers.PCh) >> 4) & 0b00001111),
				mar_in_src);

			sol1_register_8bit_set(sol1_cpu->memory.MARh, IC129 | (IC132 << 4));
			*/
			if (mccycle->mar_in_src == 0x00)
				sol1_register_8bit_set(sol1_cpu->memory.MARh, bus->z_bus);
			else
				sol1_register_8bit_set(sol1_cpu->memory.MARh, sol1_register_8bit_value(sol1_cpu->registers.PCh));
		}
		////////////////////////////////////////////////////////////////////////////

		if (DEBUG_BUSES) {
			printf("***** BUS\n");
			printf("* u_ad_bus    : "); print_word_bin(sol1_microcode->u_ad_bus); printf("\n");
			printf("* address bus : "); print_byte_bin(read_address_bus(sol1_cpu) >> 16); printf(" ");  print_word_bin(read_address_bus(sol1_cpu)); printf("\n");
			printf("*  data_bus   |");
			printf("    k_bus    |");
			printf("    w_bus    |");
			printf("    x_bus    |");
			printf("    y_bus    |");
			printf("    z_bus    ");
			printf("\n");
			printf("  "); print_byte_bin(bus->data_bus);
			printf(" | "); print_byte_bin(bus->k_bus);
			printf(" | "); print_byte_bin(bus->w_bus);
			printf(" | "); print_byte_bin(bus->x_bus);
			printf(" | "); print_byte_bin(bus->y_bus);
			printf(" | "); print_byte_bin(bus->z_bus);
			printf("\n");
			printf("******************************************************************************\n");
		}

		if (DEBUG_REGISTERS) {
			printf("***** REGISTERS\n");
			sol1_cpu_display_registers_lite(sol1_cpu);
			printf("* IR: %02x\n", sol1_register_8bit_value(sol1_microcode->IR));
			printf("******************************************************************************\n");
		}


		//CLOCK HIGH

		sol1_u_adder(sol1_microcode, mccycle->next, mccycle->final_condition);
		if (DEBUG_UADDER) {
			printf("***** U_ADDER\n");
			sol1_microcode_display_u_adder(sol1_microcode, mccycle->next, mccycle->final_condition);
			printf("******************************************************************************\n");
		}

		if (!(sol1_cpu->rom.bkpt_opcode == 0 && sol1_cpu->rom.bkpt_cycle == 0) &&
			((sol1_microcode->u_ad_bus / 64) == sol1_cpu->rom.bkpt_opcode &&
			(sol1_microcode->u_ad_bus % 64) == sol1_cpu->rom.bkpt_cycle))
		{
			printf(" Microcode Breakpoint | Opcode/Cycle:%02x%02x Finished.\n", sol1_cpu->rom.bkpt_opcode, sol1_cpu->rom.bkpt_cycle);
			debugmenu_main(sol1_cpu);
		}


		//printf("------");
		//printf("\n");

		//Sleep(1000);
		//if (next == 0x02)
		//	getch();

		/*
		if ((sol1_microcode->u_ad_bus / 64) == 0xfe || (*runtime_counter) >= 100) {
		/ run = 0;
			return;
		}
		*/


		//bus->address_bus = 0;
		bus->data_bus = 0;
		bus->k_bus = 0;
		bus->w_bus = 0;
		bus->x_bus = 0;
		bus->y_bus = 0;
		bus->z_bus = 0;

		if (step == 1)
			return;
		if (kbhit()) {
			char dddd = getch();
			if (dddd == 'd') {
				debugmenu_main_menu();
				debugmenu_main(sol1_cpu);
			}
			else if (dddd == 's')
			{
				mccycle->next = 0x00;
				return;
			}
		}

	}
	mccycle->next = 0x00;

}


int main(int argc, char** argv) {
	/*
	sol1_alu_8bit alu3;
	SOL1_BYTE x = 0;// 0xFFFE;
	SOL1_BYTE y = 0x10;
	SOL1_BYTE alu_op = 0b0000; //0b1001;
	SOL1_BYTE alu_mode = 0x1;

	SOL1_BYTE alu_cf_in_src = 0x01;
	SOL1_BYTE alu_cf_in_inv = 0x01;
	SOL1_BYTE alu_cf_out_inv = 0x01;
	SOL1_BYTE u_cf = 0;
	SOL1_BYTE msw_cf = 0;
	SOL1_BYTE shift_src = 0;
	SOL1_BYTE zbus_out_src = 0;


	for (x = 0; x <= 0xFF; x++) {
		SOL1_BYTE r = ALU_EXEC(&alu3, x, y,
			alu_op,
			alu_mode,
			alu_cf_in_src,
			alu_cf_in_inv,
			alu_cf_out_inv,
			u_cf, msw_cf, shift_src, zbus_out_src);

		printf("* ");
		printf("[%01d] %d (%02x)\t[", alu_mode, x, x);
		print_nibble_bin(alu_op);

		printf("]\t%d (%02x) = %d (%02x)\n", y, y, r, r);
		printf("* EQ="); print_nibble_bin(alu3.EQ); printf(" | ");	printf("F="); print_byte_bin(alu3.F);

		if (alu3.F == 0b00001000) printf(" F_cout");
		if (alu3.F == 0b00000100) printf(" F_lg");
		if (alu3.F == 0b00000010) printf(" F_eq");
		if (alu3.F == 0b00000001) printf(" F_zf");

		printf("\n");
		printf("* Flags: ");

		if (alu3.alu_zf != 0x00) printf("alu_zf ");
		if (alu3.alu_cf != 0x00) printf("alu_cf ");
		if (alu3.alu_of != 0x00) printf("alu_of ");
		if (alu3.alu_final_cf != 0x00) printf("alu_final_cf ");
		printf("\n");

		if (alu3.alu_cf_in_src != 0x00) printf("alu_cf_in_src ");
		if (alu3.alu_cf_in_inv != 0x00) printf("alu_cf_in_inv ");
		if (alu3.alu_cf_out_inv != 0x00) printf("alu_cf_out_inv ");

		if (alu3.alu_a_src != 0x00) printf("alu_a_src ");
		if (alu3.alu_b_src != 0x00) printf("alu_b_src ");
		printf("\n");
		printf("-----------------------------\n");

		if (x == 0xFF)
			break;
	}


	return 1;
	*/
	/*
	sol1_alu_8bit alu2;
	SOL1_BYTE A = 0x01;
	SOL1_BYTE B = 0x01;
	//SOL1_BYTE CIN = 0x01;
	SOL1_BYTE M = 0x01;

	int S = 0;
	for (S = 0; S <= 0xF; S++){
		print_byte_bin(A);
		printf("\t");
		print_byte_bin(B);
		printf("\t");
		print_nibble_bin(S);
		printf(" = ");
		//print_nibble_bin(sol1_alu_8bit_op(&alu2, A, B, CIN, S, M));
		print_nibble_bin(sol1_alu_8bit_op(&alu2, A, B, 0x00, S, M));
		printf(" ");
		if (alu2.EQ == 0x00)
			printf("0");
		else
			printf("1");
		if (alu2.COUT == 0x00)
			printf("0");
		else
			printf("1");
		printf(" | ");
		print_nibble_bin(sol1_alu_8bit_op(&alu2, A, B, 0x01, S, M));
		printf(" ");
		if (alu2.EQ == 0x00)
			printf("0");
		else
			printf("1");
		if (alu2.COUT == 0x00)
			printf("0");
		else
			printf("1");
		printf("\n");
	}
	return 1;
	*/
	/*
	sol1_alu alu;
	void sol1_alu_xor(struct sol1_alu* alu);
	void sol1_alu_or(struct sol1_alu* alu);
	void sol1_alu_and(struct sol1_alu* alu);
	void sol1_alu_not(struct sol1_alu* alu);
	void sol1_alu_shl(struct sol1_alu* alu);
	void sol1_alu_shr(struct sol1_alu* alu);

	void sol1_alu_sum(struct sol1_alu* alu);
	void sol1_alu_sub(struct sol1_alu* alu);


	alu.A = 0xFFFF;// 0b0000000000000000;
	alu.B = 0xFFFF;// 0b0000000000000000;
	alu.C = 0x00;
	alu.F = 0x00;
	alu.CIN = 0x00;

	sol1_alu_xor(&alu);

	printf("A: ");
	print_word_bin(alu.A);

	printf("B: ");
	print_word_bin(alu.B);
	printf("\n");

	printf("C: ");
	print_word_bin(alu.C);
	printf("\n");

	printf("Flags: ");
	print_byte_bin(alu.F);
	printf("\n");


	if (alu.F & 0x01)== 0x01)
		printf("SOL1_ALU_ZERO\n");
	if ((alu.F >> 1) & 0x01)== 0x01)
		printf("SOL1_ALU_EQUAL\n");
	if ((alu.F >> 2) & 0x01)== 0x01)
		printf("SOL1_ALU_LARGER\n");
	if ((alu.F >> 3) & 0x01)== 0x01)
		printf("SOL1_ALU_CARRY_OUT\n");
*/

	sol1_cpu sol1_cpu;
	sol1_cpu_init(&sol1_cpu);

	sol1_alu_8bit alu;
	sol1_alu_init(&alu);

	/*
	int opcode = 0;
	for (opcode = 0; opcode <= 0xFF; opcode++) {
		printf("****************************\n");
		printf("%02x\t%s\n", opcode, &sol1_cpu.rom.rom_desc[0x400000 + (opcode * 256)]);

		int cycle = 0;
		for (cycle = 0; cycle < 64; cycle++) {
			if (strlen((const char*)(&sol1_cpu.rom.rom_desc[(256 * 64 * opcode) + (256 * cycle)])) > 0) {
				printf("--- %02d [%02x]\n", cycle, cycle);
				printf("%s\n\n", &sol1_cpu.rom.rom_desc[(256 * 64 * opcode) + (256 * cycle)]);
			}
		}

	}
	*/

	/*
	int opcode = 0;
	for (opcode = 0; opcode < 0xFFFF; opcode++) {
		SOL1_BYTE a = (sol1_cpu.rom.roms[4][opcode] >> 3) & 0b00001111;
		SOL1_BYTE m = (sol1_cpu.rom.roms[4][opcode] >> 7) & 0b00000001;
		if (a != 0x00) {
			print_byte_bin(a);
			printf("   %d", m);
			printf("\n");
		}

	}
	*/

	sol1_microcode sol1_microcode;
	sol1_microcode_init(&sol1_microcode);

	char *filename = "bios.obj";
	printf("The filename to load is: %s", filename);

	FILE* f = fopen(filename, "rb");
	if (!f)
	{
		printf(" | Failed to open the file.\n");
		return 0;
	}

	fseek(f, 0, SEEK_END);
	long size = ftell(f);
	fseek(f, 0, SEEK_SET);

	char* buf = (char*)malloc(size * sizeof(char));

	int res = fread(buf, size, 1, f);
	if (res != 1)
	{
		printf(" | Failed to read from file.\n");
		return 0;
	}


	SOL1_BYTE memchip0[0x7FFF + 1];
	SOL1_BYTE memchip1[0x7FFF + 1];


	int i;
	for (i = 0; i < 0x7FFF + 1; i++) {
		memchip0[i] = 0x00;
		memchip1[i] = 0x00;
	}

	for (i = 0; i < size; i++) {
		//memchip0[i] = buf[i];
		sol1_cpu.memory.memory[i] = buf[i];
	}

	printf(" | OK.\n");

	/*
				 if(kbhit()){
				int key = getch();
	debugmenu_main(&sol1_cpu);
	*/



	struct mccycle mccycle;
	mccycle.next = 0x00;

	mccycle.cond_inv = 0x00;
	mccycle.cond_flags_src = 0x00;
	mccycle.cond_sel = 0x00;


	mccycle.ir_wrt = 0x00;

	mccycle.shift_src = 0x00;
	mccycle.zbus_out_src = 0x00;



	mccycle.zf_in_src = 0x00;
	mccycle.cf_in_src = 0x00;
	mccycle.sf_in_src = 0x00;
	mccycle.of_in_src = 0x00;

	mccycle.rd = 0x00;
	mccycle.wr = 0x00;


	mccycle.display_reg_load = 0x00;
	mccycle.dl_wrt = 0x00;
	mccycle.dh_wrt = 0x00;
	mccycle.cl_wrt = 0x00;
	mccycle.ch_wrt = 0x00;
	mccycle.bl_wrt = 0x00;
	mccycle.bh_wrt = 0x00;
	mccycle.al_wrt = 0x00;
	mccycle.ah_wrt = 0x00;
	mccycle.mdr_in_src = 0x00;
	mccycle.mdr_out_src = 0x00;
	mccycle.mdr_out_en = 0x00;
	mccycle.mdrl_wrt = 0x00;
	mccycle.mdrh_wrt = 0x00;
	mccycle.tdrl_wrt = 0x00;
	mccycle.tdrh_wrt = 0x00;
	mccycle.dil_wrt = 0x00;
	mccycle.dih_wrt = 0x00;
	mccycle.sil_wrt = 0x00;
	mccycle.sih_wrt = 0x00;
	mccycle.marl_wrt = 0x00;
	mccycle.marh_wrt = 0x00;
	mccycle.bpl_wrt = 0x00;
	mccycle.bph_wrt = 0x00;
	mccycle.pcl_wrt = 0x00;
	mccycle.pch_wrt = 0x00;
	mccycle.spl_wrt = 0x00;
	mccycle.sph_wrt = 0x00;



	mccycle.mar_in_src = 0x00;


	mccycle.ptb_wrt = 0x00;
	mccycle.pagtbl_ram_we = 0x00;
	mccycle.mdr_to_pagtbl_en = 0x00;
	mccycle.force_user_ptb = 0x00;

	mccycle.gl_wrt = 0x00;
	mccycle.gh_wrt = 0x00;
	mccycle.imm = 0x00;


	mccycle.sspl_wrt = 0x01; ////////?????????????????
	mccycle.ssph_wrt = 0x01; ////////?????????????????

	mccycle.page_table_addr_src = 0x0; ////////?????????????????



	//?????????????
	mccycle.memory_io = 0x00; // bus_mem_io //?????????????????
	mccycle.page_present = 0x00; ////////?????????????????
	mccycle.page_writable = 0x00; ////////?????????????????
	//?????????????
	//mccycle.buffer_rd = 0x00;
	//mccycle.buffer_wr = 0x00;
	//mccycle.buffer_mem_io = 0x00;
	//?????????????
	//?????????????


	// CPU FLAGS
	//mccycle.MSW_ZF = 0x0; ////////?????????????????
	//mccycle.MSW_CF = 0x00; ////////?????????????????
	//mccycle.MSW_SF = 0x00; ////////?????????????????
	//mccycle.MSW_OF = 0x00; ////////?????????????????
	//mccycle.MSW_12 = 0x00; ////////?????????????????
	//mccycle.MSW_13 = 0x00; ////////?????????????????
	//mccycle.MSW_14 = 0x00; ////////?????????????????
	//mccycle.MSW_15 = 0x00; ////////?????????????????

	// STATUS FLAGS
	//mccycle.msw_dma_ack = 0x00; ////////?????????????????
	//mccycle.msw_interrupt_enable = 0x00; ////////?????????????????
	//mccycle.msw_cpu_mode = 0x00; ////////?????????????????
	//mccycle.msw_paging_en = 0x0; ////////?????????????????
	//mccycle.msw_halt = 0x00; ////////?????????????????
	//mccycle.msw_display_reg_load = 0x00; ////////?????????????????
	//mccycle.MSW_14 = 0x00; ////////?????????????????
	//mccycle.msw_dir = 0x00; ////////?????????????????

	//mccycle.mswh_wrt = 0x00; // flags
	mccycle.status_wrt = 0x00; //mswl_wrt // status (flags de controle)



	//
	mccycle.clear_all_ints = 0x00;
	mccycle.int_vector = 0x00; ////////?????????????????
	mccycle.int_mask = 0x00; ////////?????????????????
	//mccycle.int_masks_wrt = 0x00; ////////?????????????????
	mccycle.mask_flags_wrt = 0x00;
	mccycle.int_status = 0x00; ////////?????????????????
	mccycle.int_vector_wrt = 0x00;
	mccycle.int_ack = 0x00;
	mccycle.int_request = 0x00; ////////?????????????????
	//


	mccycle.int_pending = 0x00; //?? int_request + msw_interrupt_enable
	mccycle.dma_req = 0x00; ////////????????????????? CLOCK DE DMA
	mccycle.any_interruption = 0x00; //?? int_endind "+" dma_req


	mccycle.wait = 0x00; ////////?????????????????
	mccycle.ext_input = 0x00; ////////?????????????????

	mccycle.final_condition = 0x00;


	mccycle.panel_regsel = 0x00;

	/////



	alu.alu_zf = 0x00; // flags do alu
	alu.alu_cf = 0x00;
	alu.alu_of = 0x00;

	alu.alu_final_cf = 0x00;

	alu.alu_op = 0x00;
	alu.alu_mode = 0x00;
	alu.alu_cf_in_src = 0x00;
	alu.alu_cf_in_inv = 0x00;
	alu.alu_cf_out_inv = 0x00;

	alu.alu_a_src = 0x00;
	alu.alu_b_src = 0x00;
	//



	/////


	//SOL1_DWORD u_ad_bus = 0b0000000000000000;


	struct bus bus;


	bus.data_bus = 0b00000000;

	bus.k_bus = 0b00000000; // input pra alu x e y
	bus.w_bus = 0b00000000; // input pra alu x e y
	bus.x_bus = 0b00000000; //alu entrada
	bus.y_bus = 0b00000000; //alu entrada
	bus.z_bus = 0b00000000; //alu saida


	long runtime_counter = 0;




	//cpu_print(&z80);
	int run = 0;
	int debug = 0;
	while (1) {
		char *input = (char*)malloc(sizeof(char) * 257);

		sol1_cpu_memory_display(&sol1_cpu);
		sol1_cpu_display_registers_lite(&sol1_cpu);
		printf("Flags: "); mswh_flags_desc(&sol1_cpu); printf("\n");
		printf("Status: "); mswl_status_desc(&sol1_cpu); printf("\n");


		printf(">> ");
		scanf("%s", input);

		if (input[0] != 'n' && input[0] != 'N' &&
			input[0] != 'r' && input[0] != 'R' &&
			input[0] != 'b' && input[0] != 'B' &&
			input[0] != 'p' && input[0] != 'P' &&
			input[0] != 's' && input[0] != 'S') {
			size_t numdigits = strlen(input) / 2;
			size_t i;
			for (i = 0; i != numdigits; ++i)
			{
				unsigned char output = 16 * toInt(input[2 * i]) + toInt(input[2 * i + 1]);
				sol1_cpu.memory.memory[i] = output;
				//printf("%x\n", output[i]);
			}

			step = 1;
			sol1_registers_set(sol1_cpu.registers.PCl, sol1_cpu.registers.PCh, 0x00);
			sol1_registers_set(sol1_cpu.memory.MARl, sol1_cpu.memory.MARh, 0x00);


			sol1_cpu_memory_display(&sol1_cpu);
			sol1_cpu_display_registers_lite(&sol1_cpu);
			printf("Flags: "); mswh_flags_desc(&sol1_cpu); printf("\n");
			printf("Status: "); mswl_status_desc(&sol1_cpu); printf("\n");
			runtime_counter = 0;
		}
		else if (input[0] == 'n' || input[0] == 'N') {
			debugmenu_main_menu();
			debugmenu_main(&sol1_cpu);
			debug = 1;
		}
		else if (input[0] == 'r' || input[0] == 'R') {
			run = 1;
			step = 0;
		}
		else if (input[0] == 's' || input[0] == 'S') {
			step = 1;
		}
		else if (input[0] == 'b' || input[0] == 'B') {
			step = 1;
			sol1_microcode.u_adder = sol1_microcode.old_u_ad_bus;
		}
		else if (input[0] == 'p' || input[0] == 'P') {
			sol1_register_8bit_set(sol1_microcode.IR, 0x00);
			sol1_cpu_reset(&sol1_cpu);
			sol1_memory_reset(&sol1_cpu.memory);
			debug = 1;
		}

		free(input);

		if (debug == 0)
			mc_sequencer(&sol1_cpu,
				&alu,
				&sol1_microcode,
				&bus,
				&mccycle,
				memchip0,
				memchip1,
				&runtime_counter
			);
		else
			debug = 0;

		if (run == 0 && step == 0)
			sol1_microcode.u_adder = 0x10; // 0xFE * 64;
		//sol1_microcode.u_ad_bus = 0xFE * 64;
		//sol1_registers_set(sol1_microcode.U_ADDRESSl, sol1_microcode.U_ADDRESSh, sol1_microcode.u_ad_bus);

		/*
		do {
			//cls(hConsole);

			//COORD pos = { 0, 0 };
			//SetConsoleCursorPosition(hConsole, pos);

			cpu_exec(&z80);
			printf("%s", z80.last_op_desc);
			cpu_print(&z80);
			usleep(100 * 1000);
			//sleep(1);
		} while (((z80.registers.IFF & IFF_HALT) != IFF_HALT) && run);
		*/
		//run = 0;
	}

	/*
	mc_sequencer(&sol1_cpu,
		&alu,
		&sol1_microcode,
		&sol1_rom,
		&bus,
		&mccycle,
		memchip0,
		memchip1,
		&runtime_counter
	);
	*/
	//return 0;



	return 0;
}
